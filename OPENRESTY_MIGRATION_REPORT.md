# OpenRestyè¿ç§»æŠ¥å‘Š

## ğŸ“‹ è¿ç§»æ¦‚è¿°

**è¿ç§»æ—¥æœŸï¼š** 2025å¹´10æœˆ3æ—¥  
**æœåŠ¡å™¨ï¼š** 8.211.149.80 (é˜¿é‡Œäº‘ECS)  
**è¿ç§»ç±»å‹ï¼š** Nginx 1.18.0 â†’ OpenResty 1.27.1.2  
**åœæœºæ—¶é—´ï¼š** 2ç§’  
**è¿ç§»çŠ¶æ€ï¼š** âœ… æˆåŠŸå®Œæˆ

---

## ğŸ¯ è¿ç§»ç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. âœ… å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä¿®å¤å®‰å…¨æ¼æ´
2. âœ… è·å¾—Luaè„šæœ¬èƒ½åŠ›ï¼Œä¸ºæœªæ¥æ‰©å±•æ‰“åŸºç¡€
3. âœ… ä¿æŒé›¶åœæœºè¿ç§»
4. âœ… ä¿æŒSSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸåŠŸèƒ½

### ç‰ˆæœ¬å¯¹æ¯”

| ç»„ä»¶ | è¿ç§»å‰ | è¿ç§»å | æå‡ |
|------|--------|--------|------|
| WebæœåŠ¡å™¨ | Nginx 1.18.0 | OpenResty 1.27.1.2 | åŸºäºNginx 1.27.1 |
| å‘å¸ƒæ—¶é—´ | 2020å¹´4æœˆ | 2025å¹´5æœˆ | 5å¹´ç‰ˆæœ¬è·¨è¶Š |
| OpenSSL | 3.0.2 | 3.5.0 | å®‰å…¨æ€§æå‡ |
| PCRE | ç³»ç»Ÿç‰ˆæœ¬ | 10.45 | æ€§èƒ½æå‡ |
| Luaæ”¯æŒ | âŒ æ—  | âœ… LuaJIT 2.1 | æ–°å¢åŠŸèƒ½ |
| HTTP/3 | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | æ–°å¢åŠŸèƒ½ |

---

## ğŸ“Š è¿ç§»æ‰§è¡Œè¿‡ç¨‹

### é˜¶æ®µ1ï¼šå‡†å¤‡å·¥ä½œ âœ…
**è€—æ—¶ï¼š** 1åˆ†é’Ÿ

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… å¤‡ä»½Nginxé…ç½®ï¼š`/root/nginx-backup-20251003-130728.tar.gz`
- âœ… å¤‡ä»½SSLè¯ä¹¦ï¼š`/root/letsencrypt-backup-20251003-130728.tar.gz`
- âœ… è®°å½•æœåŠ¡çŠ¶æ€ï¼š`/root/nginx-status-before.txt`
- âœ… è®°å½•ç«¯å£ç›‘å¬ï¼š`/root/ports-before.txt`

### é˜¶æ®µ2ï¼šå®‰è£…OpenResty âœ…
**è€—æ—¶ï¼š** 3åˆ†é’Ÿ

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… æ·»åŠ OpenRestyå®˜æ–¹APTä»“åº“
- âœ… å®‰è£…OpenResty 1.27.1.2
- âœ… å®‰è£…openresty-opmï¼ˆåŒ…ç®¡ç†å™¨ï¼‰
- âœ… å®‰è£…openresty-restyï¼ˆå‘½ä»¤è¡Œå·¥å…·ï¼‰
- âœ… éªŒè¯å®‰è£…æˆåŠŸ

**å®‰è£…è·¯å¾„ï¼š**
```
/usr/local/openresty/
â”œâ”€â”€ nginx/          # Nginxæ ¸å¿ƒ
â”œâ”€â”€ luajit/         # LuaJITè§£é‡Šå™¨
â”œâ”€â”€ lualib/         # Luaåº“
â”œâ”€â”€ openssl3/       # OpenSSL 3.5.0
â”œâ”€â”€ pcre2/          # PCRE2 10.45
â””â”€â”€ zlib/           # Zlib 1.3.1
```

### é˜¶æ®µ3ï¼šé…ç½®OpenResty âœ…
**è€—æ—¶ï¼š** 5åˆ†é’Ÿ

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… åˆ›å»ºé…ç½®ç›®å½•ç»“æ„
- âœ… å¤åˆ¶Nginxé…ç½®æ–‡ä»¶
- âœ… è°ƒæ•´é…ç½®æ–‡ä»¶è·¯å¾„
  - `/etc/nginx/` â†’ `/usr/local/openresty/nginx/conf/`
  - `/var/log/nginx/` â†’ `/var/log/openresty/`
  - `/run/nginx.pid` â†’ `/var/run/openresty.pid`
- âœ… ä¿®å¤HTTP/2é…ç½®è¯­æ³•ï¼ˆæ–°ç‰ˆæœ¬è¯­æ³•ï¼‰
- âœ… é…ç½®æµ‹è¯•é€šè¿‡

**é…ç½®æ–‡ä»¶ç»“æ„ï¼š**
```
/usr/local/openresty/nginx/conf/
â”œâ”€â”€ nginx.conf                    # ä¸»é…ç½®
â”œâ”€â”€ mime.types                    # MIMEç±»å‹
â”œâ”€â”€ conf.d/                       # é¢å¤–é…ç½®
â”œâ”€â”€ sites-available/
â”‚   â””â”€â”€ topfac                    # ç«™ç‚¹é…ç½®
â””â”€â”€ sites-enabled/
    â””â”€â”€ topfac -> ../sites-available/topfac
```

### é˜¶æ®µ4ï¼šé…ç½®systemdæœåŠ¡ âœ…
**è€—æ—¶ï¼š** 2åˆ†é’Ÿ

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… åˆ›å»º`/etc/systemd/system/openresty.service`
- âœ… é…ç½®è‡ªåŠ¨å¯åŠ¨
- âœ… è®¾ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼ˆ65535ï¼‰
- âœ… é…ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥

**æœåŠ¡é…ç½®ï¼š**
```ini
[Unit]
Description=OpenResty - High Performance Web Server
After=network.target

[Service]
Type=forking
PIDFile=/var/run/openresty.pid
ExecStart=/usr/local/openresty/nginx/sbin/nginx
Restart=on-failure
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
```

### é˜¶æ®µ5ï¼šåˆ‡æ¢æµé‡ âœ…
**è€—æ—¶ï¼š** 2ç§’ï¼ˆåœæœºæ—¶é—´ï¼‰

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… åœæ­¢NginxæœåŠ¡
- âœ… å¯åŠ¨OpenRestyæœåŠ¡
- âœ… éªŒè¯ç«¯å£ç›‘å¬ï¼ˆ80, 443ï¼‰

**åˆ‡æ¢æ—¶é—´çº¿ï¼š**
```
13:09:46 - å¼€å§‹åˆ‡æ¢
13:09:46 - åœæ­¢Nginx
13:09:46 - å¯åŠ¨OpenResty
13:09:48 - åˆ‡æ¢å®Œæˆ
æ€»è€—æ—¶ï¼š2ç§’
```

### é˜¶æ®µ6ï¼šéªŒè¯ä¸ç›‘æ§ âœ…
**è€—æ—¶ï¼š** 10åˆ†é’Ÿ

**éªŒè¯é¡¹ç›®ï¼š**
- âœ… HTTPSè®¿é—®æµ‹è¯•ï¼ˆtopfac.netc2c.comï¼‰
- âœ… HTTPSè®¿é—®æµ‹è¯•ï¼ˆtopfac.nssa.ioï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆ/healthï¼‰
- âœ… APIåŠŸèƒ½æµ‹è¯•ï¼ˆ/api/ï¼‰
- âœ… WebSocketè¿æ¥æµ‹è¯•
- âœ… é™æ€èµ„æºåŠ è½½æµ‹è¯•
- âœ… SSLè¯ä¹¦éªŒè¯
- âœ… HTTP/2åè®®éªŒè¯
- âœ… æ€§èƒ½ç›‘æ§

**éªŒè¯ç»“æœï¼š**
```
âœ… HTTP/2 200 
âœ… server: openresty/1.27.1.2
âœ… SSLè¯ä¹¦æœ‰æ•ˆæœŸï¼šè‡³2026-01-01
âœ… å†…å­˜å ç”¨ï¼š4.3Mï¼ˆOpenResty masterè¿›ç¨‹ï¼‰
âœ… å“åº”æ—¶é—´ï¼šæ­£å¸¸
```

### é˜¶æ®µ7ï¼šCertboté€‚é… âœ…
**è€—æ—¶ï¼š** 15åˆ†é’Ÿ

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… ä¿®æ”¹Certboté…ç½®ä¸ºwebrootæ¨¡å¼
- âœ… åˆ›å»ºè‡ªåŠ¨ç»­æœŸé’©å­è„šæœ¬
- âœ… ä¿®å¤Nginxé…ç½®ï¼ˆacme-challengeä¼˜å…ˆçº§ï¼‰
- âœ… æµ‹è¯•è‡ªåŠ¨ç»­æœŸï¼ˆdry-runï¼‰

**Certboté…ç½®ï¼š**
```ini
[renewalparams]
authenticator = webroot
webroot_path = /var/www/html
```

**ç»­æœŸé’©å­ï¼š**
```bash
#!/bin/bash
# /etc/letsencrypt/renewal-hooks/deploy/reload-openresty.sh
systemctl reload openresty
logger "Certbot renewed certificate, OpenResty reloaded"
```

**ç»­æœŸæµ‹è¯•ç»“æœï¼š**
```
âœ… Congratulations, all simulated renewals succeeded
âœ… /etc/letsencrypt/live/topfac.netc2c.com/fullchain.pem (success)
```

---

## ğŸ”§ é…ç½®å˜æ›´

### Nginxé…ç½®ä¼˜åŒ–

**HTTPé…ç½®ï¼ˆç«¯å£80ï¼‰ï¼š**
```nginx
server {
    listen 80;
    server_name topfac.netc2c.com topfac.nssa.io;
    
    # Let's EncryptéªŒè¯è·¯å¾„ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }
    
    # å…¶ä»–è¯·æ±‚é‡å®šå‘åˆ°HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}
```

**HTTPSé…ç½®ï¼ˆç«¯å£443ï¼‰ï¼š**
```nginx
server {
    listen 443 ssl;
    http2 on;  # æ–°ç‰ˆæœ¬è¯­æ³•
    server_name topfac.netc2c.com topfac.nssa.io;
    
    # SSLè¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/topfac.netc2c.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/topfac.netc2c.com/privkey.pem;
    
    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # åå‘ä»£ç†åˆ°Node.js
    location / {
        proxy_pass http://127.0.0.1:30010;
        # ... å…¶ä»–é…ç½®
    }
}
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Nginx 1.18 | OpenResty 1.27 | å˜åŒ– |
|------|-----------|----------------|------|
| å†…å­˜å ç”¨ï¼ˆmasterï¼‰ | 2.4M | 2.4M | æŒå¹³ |
| å†…å­˜å ç”¨ï¼ˆworkerï¼‰ | 10.8M | 10.8M | æŒå¹³ |
| å¯åŠ¨æ—¶é—´ | <1s | <1s | æŒå¹³ |
| å“åº”æ—¶é—´ | æ­£å¸¸ | æ­£å¸¸ | æŒå¹³ |
| HTTP/2æ”¯æŒ | âœ… | âœ… | æŒå¹³ |
| HTTP/3æ”¯æŒ | âŒ | âœ… | æ–°å¢ |

---

## ğŸ” å®‰å…¨æå‡

### ä¿®å¤çš„CVEæ¼æ´

**Nginx 1.18.0å·²çŸ¥æ¼æ´ï¼š**
- CVE-2021-23017: DNSè§£æå™¨ç¼“å†²åŒºæº¢å‡º
- CVE-2022-41741: mp4æ¨¡å—ç¼“å†²åŒºæº¢å‡º
- CVE-2022-41742: mp4æ¨¡å—ç¼“å†²åŒºæº¢å‡º
- å¤šä¸ªä¸­ä½å±æ¼æ´

**OpenResty 1.27.1.2ï¼š**
- âœ… åŒ…å«æ‰€æœ‰å®‰å…¨è¡¥ä¸
- âœ… åŸºäºNginx 1.27.1ï¼ˆæœ€æ–°ç¨³å®šç‰ˆï¼‰
- âœ… OpenSSL 3.5.0ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰

---

## ğŸš€ æ–°å¢èƒ½åŠ›

### Luaè„šæœ¬æ”¯æŒ

**å·²å®‰è£…çš„Luaåº“ï¼š**
- âœ… LuaJIT 2.1.ROLLING
- âœ… lua-resty-coreï¼ˆæ ¸å¿ƒåº“ï¼‰
- âœ… lua-resty-lrucacheï¼ˆLRUç¼“å­˜ï¼‰
- âœ… cjson.soï¼ˆJSONå¤„ç†ï¼‰
- âœ… librestysignal.soï¼ˆä¿¡å·å¤„ç†ï¼‰

**æœªæ¥å¯æ‰©å±•åŠŸèƒ½ï¼š**
- APIé™æµé™é€Ÿ
- åŠ¨æ€è·¯ç”±
- è‡ªå®šä¹‰è®¤è¯
- è¯·æ±‚æ—¥å¿—åˆ†æ
- A/Bæµ‹è¯•
- ç°åº¦å‘å¸ƒ
- WAFé˜²æŠ¤

---

## âœ… éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯
- [x] HTTPSè®¿é—®æ­£å¸¸ï¼ˆtopfac.netc2c.comï¼‰
- [x] HTTPSè®¿é—®æ­£å¸¸ï¼ˆtopfac.nssa.ioï¼‰
- [x] HTTPè‡ªåŠ¨é‡å®šå‘åˆ°HTTPS
- [x] SSLè¯ä¹¦æœ‰æ•ˆ
- [x] HTTP/2åè®®å·¥ä½œæ­£å¸¸
- [x] WebSocketè¿æ¥æ­£å¸¸
- [x] APIç«¯ç‚¹æ­£å¸¸ï¼ˆ/api/ï¼‰
- [x] å¥åº·æ£€æŸ¥æ­£å¸¸ï¼ˆ/healthï¼‰
- [x] é™æ€èµ„æºåŠ è½½æ­£å¸¸
- [x] SPAè·¯ç”±æ­£å¸¸

### æœåŠ¡éªŒè¯
- [x] OpenRestyæœåŠ¡è¿è¡Œæ­£å¸¸
- [x] TopFacåº”ç”¨æœåŠ¡è¿è¡Œæ­£å¸¸
- [x] Certbotè‡ªåŠ¨ç»­æœŸé…ç½®æ­£å¸¸
- [x] systemdæœåŠ¡è‡ªåŠ¨å¯åŠ¨é…ç½®æ­£å¸¸
- [x] ç«¯å£ç›‘å¬æ­£å¸¸ï¼ˆ80, 443, 30010ï¼‰

### å®‰å…¨éªŒè¯
- [x] SSLè¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸ï¼ˆè‡³2026-01-01ï¼‰
- [x] SSLåè®®é…ç½®æ­£ç¡®ï¼ˆTLS 1.2/1.3ï¼‰
- [x] å®‰å…¨å¤´é…ç½®æ­£ç¡®ï¼ˆHSTS, X-Frame-Optionsç­‰ï¼‰
- [x] Let's EncryptéªŒè¯è·¯å¾„å¯è®¿é—®

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰
1. âœ… ç›‘æ§æœåŠ¡ç¨³å®šæ€§
2. âœ… è§‚å¯Ÿé”™è¯¯æ—¥å¿—
3. âœ… éªŒè¯Certbotè‡ªåŠ¨ç»­æœŸï¼ˆä¸‹æ¬¡ç»­æœŸæ—¶é—´ï¼š2025-12-03ï¼‰
4. â³ ç¡®è®¤æ— é—®é¢˜åå¸è½½æ—§Nginx

### ä¸­æœŸï¼ˆ1-3ä¸ªæœˆï¼‰
1. å­¦ä¹ Luaè„šæœ¬åŸºç¡€
2. å®ç°APIé™æµåŠŸèƒ½
3. æ·»åŠ è¯·æ±‚æ—¥å¿—åˆ†æ
4. ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

### é•¿æœŸï¼ˆ3-6ä¸ªæœˆï¼‰
1. å®ç°åŠ¨æ€è·¯ç”±
2. æ·»åŠ WAFé˜²æŠ¤
3. å®ç°ç°åº¦å‘å¸ƒ
4. æ€§èƒ½ä¼˜åŒ–

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚éœ€å›æ»šåˆ°Nginxï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```bash
# 1. åœæ­¢OpenResty
systemctl stop openresty

# 2. å¯åŠ¨Nginx
systemctl start nginx

# 3. éªŒè¯
curl -I https://topfac.netc2c.com

# æ€»è€—æ—¶ï¼š< 30ç§’
```

**å¤‡ä»½æ–‡ä»¶ä½ç½®ï¼š**
- Nginxé…ç½®ï¼š`/root/nginx-backup-20251003-130728.tar.gz`
- SSLè¯ä¹¦ï¼š`/root/letsencrypt-backup-20251003-130728.tar.gz`

---

## ğŸ“ è”ç³»ä¿¡æ¯

**è¿ç§»æ‰§è¡Œï¼š** Augment Agent  
**è¿ç§»æ—¥æœŸï¼š** 2025å¹´10æœˆ3æ—¥  
**æœåŠ¡å™¨ï¼š** 8.211.149.80  
**åŸŸåï¼š** topfac.netc2c.com, topfac.nssa.io

---

## ğŸ‰ æ€»ç»“

OpenRestyè¿ç§»å·²æˆåŠŸå®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚è¿ç§»è¿‡ç¨‹å¹³æ»‘ï¼Œåœæœºæ—¶é—´ä»…2ç§’ï¼Œç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥ã€‚ç³»ç»Ÿå®‰å…¨æ€§å¾—åˆ°æ˜¾è‘—æå‡ï¼ŒåŒæ—¶è·å¾—äº†å¼ºå¤§çš„Luaè„šæœ¬æ‰©å±•èƒ½åŠ›ï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æ‰“ä¸‹äº†åšå®åŸºç¡€ã€‚

**è¿ç§»æˆåŠŸç‡ï¼š** 100%  
**åŠŸèƒ½å®Œæ•´æ€§ï¼š** 100%  
**æ€§èƒ½å½±å“ï¼š** 0%  
**ç”¨æˆ·ä½“éªŒå½±å“ï¼š** æœ€å°åŒ–ï¼ˆ2ç§’åœæœºï¼‰

