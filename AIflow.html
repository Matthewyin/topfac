<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Êû∂ÊûÑÊó∂Â∫èÊ®°ÊãüÂô®</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', monospace; }
        
        /* ‰ª£Á†ÅÈù¢ÊùøÊªöÂä®Êù° */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* SVG Âä®ÁîªÂÆö‰πâ */
        @keyframes drawLine {
            to { stroke-dashoffset: 0; }
        }
        @keyframes fadeArrow {
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // === 1. ÂÆö‰πâÂÆû‰Ωì (Ê≥≥ÈÅì) ===
        // TOOLS ÂÆû‰ΩìÂÆö‰πâ‰øùÊåÅ‰∏çÂèò
        const ENTITIES = {
            USER: { id: 'USER', name: 'User', icon: 'üë§', color: 'text-gray-300', bg: 'bg-gray-800' },
            HOST: { id: 'HOST', name: 'Host/Env', icon: 'üíª', color: 'text-blue-400', bg: 'bg-blue-900/30' },
            AGENT: { id: 'AGENT', name: 'Agent Logic', icon: 'ü§ñ', color: 'text-purple-400', bg: 'bg-purple-900/30' },
            LLM: { id: 'LLM', name: 'LLM API', icon: 'üß†', color: 'text-green-400', bg: 'bg-green-900/30' },
            MCP: { id: 'MCP', name: 'MCP Server', icon: 'üß∞', color: 'text-orange-400', bg: 'bg-orange-900/30' },
            TOOLS: { id: 'TOOLS', name: 'Actual Tool', icon: 'üî®', color: 'text-red-400', bg: 'bg-red-900/30' }
        };

        // === SVG ÁÆ≠Â§¥ÁªÑ‰ª∂ ===
        const Arrow = ({ widthPercent, isLeftToRight, label, isCurrent, index }) => {
            const color = isCurrent ? '#fbbf24' : '#e2e8f0'; 
            const labelBg = isCurrent 
                ? 'bg-slate-900/90 text-yellow-200 border-yellow-500/50' 
                : 'bg-slate-800/80 text-white border-slate-600';
            
            return (
                <div className="absolute w-full h-12 flex items-center justify-center" style={{ zIndex: 10 }}>
                    <div style={{ width: `${widthPercent}%`, position: 'relative', height: '100%' }}>
                        <svg width="100%" height="100%" style={{ overflow: 'visible' }}>
                            <defs>
                                <marker id={`arrowhead-${index}`} markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill={color} 
                                    style={{ 
                                        opacity: isCurrent ? 0 : 1, 
                                        animation: isCurrent ? 'fadeArrow 0.1s linear 0.6s forwards' : 'none' 
                                    }} 
                                />
                                </marker>
                            </defs>
                            <line 
                                x1={isLeftToRight ? "0" : "100%"} 
                                y1="50%" 
                                x2={isLeftToRight ? "100%" : "0"} 
                                y2="50%" 
                                stroke={color} 
                                strokeWidth="2" 
                                markerEnd={`url(#arrowhead-${index})`}
                                pathLength="1"
                                strokeDasharray={isCurrent ? "1" : "none"}
                                strokeDashoffset={isCurrent ? "1" : "0"}
                                style={{ 
                                    animation: isCurrent ? 'drawLine 0.6s ease-out forwards' : 'none' 
                                }}
                            />
                        </svg>
                        <div className={`absolute top-0 w-full text-center text-xs md:text-sm font-bold font-mono px-2 py-1 rounded border transition-colors duration-500 ${labelBg}`}
                             style={{ 
                                 transform: 'translateY(-50%)',
                                 opacity: isCurrent ? 0 : 1,
                                 animation: isCurrent ? 'fadeArrow 0.3s ease-out forwards' : 'none'
                             }}>
                            {label}
                        </div>
                    </div>
                </div>
            );
        };

        // === ‰∏ªÁªÑ‰ª∂ ===
        const App = () => {
            const [config, setConfig] = useState({ agent: false, fc: false, mcp: false });
            const [sequence, setSequence] = useState([]);
            const [currentStepIndex, setCurrentStepIndex] = useState(-1);
            const [isPlaying, setIsPlaying] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const [activeLifelines, setActiveLifelines] = useState(['USER', 'HOST', 'LLM']);
            
            const scrollRef = useRef(null);

            // === ‰ºòÂåñÊªöÂä®ÈÄªËæë ===
            useEffect(() => {
                if (scrollRef.current && isPlaying) {
                    scrollRef.current.scrollTo({
                        top: scrollRef.current.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, [currentStepIndex, isPlaying]);

            const generateSequence = (cfg) => {
                const seq = [];
                seq.push({ from: 'USER', to: 'HOST', label: 'ÊèêÈóÆ: "Êü•ËØ¢ÈîÄÈáè"', data: { input: "Êü•ËØ¢ 2023 Âπ¥ Q3 ÈîÄÈáè" } });

                if (!cfg.agent && !cfg.fc && !cfg.mcp) {
                    // 1. Basic Chat
                    seq.push({ from: 'HOST', to: 'LLM', label: 'ÂèëÈÄÅ Prompt', data: { messages: [{role: "user", content: "Êü•ËØ¢ÈîÄÈáè"}] } });
                    seq.push({ from: 'LLM', to: 'HOST', label: 'ÂõûÂ§çÊñáÊú¨', data: { content: "Êä±Ê≠âÔºåÊàëÊó†Ê≥ïËÆøÈóÆÊï∞ÊçÆÂ∫ì„ÄÇ" } });
                    seq.push({ from: 'HOST', to: 'USER', label: 'ÊòæÁ§∫ÁªìÊûú', data: { output: "Êä±Ê≠âÔºåÊàëÊó†Ê≥ïËÆøÈóÆÊï∞ÊçÆÂ∫ì„ÄÇ" } });
                
                } else if (!cfg.agent && cfg.fc && !cfg.mcp) {
                    // 2. Scripted Function Calling (Host -> Tools -> Host)
                    seq.push({ from: 'HOST', to: 'LLM', label: 'ÂèëÈÄÅ Prompt + Tools', data: { messages: [{role: "user", content: "Êü•ËØ¢..."}], tools: [{name: "query_db"}] } });
                    seq.push({ from: 'LLM', to: 'HOST', label: 'ËØ∑Ê±ÇË∞ÉÁî®ÂáΩÊï∞', data: { tool_calls: [{ name: "query_db", args: "{'year':2023}" }] } });
                    
                    seq.push({ from: 'HOST', to: 'TOOLS', label: 'ÊâßË°åÊú¨Âú∞ÂáΩÊï∞', data: { exec: "query_db(2023)" } });
                    seq.push({ from: 'TOOLS', to: 'HOST', label: 'ÂáΩÊï∞ËøîÂõûÊï∞ÊçÆ', data: { return: 1000000 } });

                    seq.push({ from: 'HOST', to: 'LLM', label: 'Êèê‰∫§ÂáΩÊï∞ÁªìÊûú', data: { role: "tool", content: "100‰∏á" } });
                    seq.push({ from: 'LLM', to: 'HOST', label: 'ÊúÄÁªàÂõûÂ§ç', data: { content: "ÈîÄÈáèÊòØ 100 ‰∏á„ÄÇ" } });
                    seq.push({ from: 'HOST', to: 'USER', label: 'ÊòæÁ§∫ÁªìÊûú', data: { output: "ÈîÄÈáèÊòØ 100 ‰∏á„ÄÇ" } });
                
                } else if (cfg.agent && cfg.fc && !cfg.mcp) {
                    // 3. Agent Loop (Agent -> Host -> Tools -> Host -> Agent)
                    seq.push({ from: 'HOST', to: 'AGENT', label: 'ÊøÄÊ¥ªÊô∫ËÉΩ‰Ωì', data: { task: "Analyze Sales" } });
                    seq.push({ from: 'AGENT', to: 'LLM', label: 'ÊÄùËÄÉ (ReAct)', data: { system: "You are an agent...", messages: [{role: "user", content: "Analyze..."}] } });
                    seq.push({ from: 'LLM', to: 'AGENT', label: 'ÂÜ≥Á≠ñ: Ë∞ÉÁî®Â∑•ÂÖ∑', data: { tool_calls: [{ name: "search_file" }] } });
                    
                    // Agent ËØ∑Ê±Ç Host ÁéØÂ¢ÉÊâßË°åÂ∑•ÂÖ∑
                    seq.push({ from: 'AGENT', to: 'HOST', label: 'ËØ∑Ê±ÇÁéØÂ¢ÉÊâßË°å', data: { cmd: "run search_file" } });
                    seq.push({ from: 'HOST', to: 'TOOLS', label: 'Á≥ªÁªüË∞ÉÁî® grep', data: { exec: "grep 'sales' data.csv" } });
                    seq.push({ from: 'TOOLS', to: 'HOST', label: 'IO ËæìÂá∫', data: { stdout: "sales_q3 = 1M" } });
                    seq.push({ from: 'HOST', to: 'AGENT', label: 'ËøîÂõûÊâßË°åÁªìÊûú', data: { result: "Found: sales_q3 = 1M" } });

                    seq.push({ from: 'AGENT', to: 'LLM', label: 'ËßÇÂØü (Observation)', data: { role: "tool", content: "sales_q3 = 1M" } });
                    seq.push({ from: 'LLM', to: 'AGENT', label: 'ÁîüÊàêÁªìËÆ∫', data: { content: "Analysis complete: 1M" } });
                    seq.push({ from: 'AGENT', to: 'HOST', label: 'ËøîÂõû‰ªªÂä°ÁªìÊûú', data: { final_answer: "1M" } });
                    seq.push({ from: 'HOST', to: 'USER', label: 'ÊòæÁ§∫ÁªìÊûú', data: { output: "1M" } });
                
                } else if (cfg.agent && cfg.fc && cfg.mcp) {
                    // 4. Full MCP (Agent -> MCP -> Tools -> MCP -> Agent)
                    seq.push({ from: 'HOST', to: 'AGENT', label: 'ÂêØÂä®‰ªªÂä°', data: { task: "Read Excel via MCP" } });
                    seq.push({ from: 'AGENT', to: 'LLM', label: 'ÊÄùËÄÉ', data: { messages: [{role: "user", content: "Read Excel..."}] } });
                    seq.push({ from: 'LLM', to: 'AGENT', label: 'ÂÜ≥Á≠ñ: Call mcp_tool', data: { tool_calls: [{ name: "mcp_excel_read" }] } });
                    
                    seq.push({ from: 'AGENT', to: 'MCP', label: 'MCP ÂçèËÆÆËØ∑Ê±Ç', data: { jsonrpc: "2.0", method: "tools/call", params: { name: "read_sheet" } } });
                    
                    seq.push({ from: 'MCP', to: 'TOOLS', label: 'È©±Âä®Â∫ïÂ±ÇÂ∑•ÂÖ∑', data: { internal_call: "pandas.read_excel()" } });
                    seq.push({ from: 'TOOLS', to: 'MCP', label: 'Â∑•ÂÖ∑ËøîÂõû', data: { raw_data: "rows..." } });

                    seq.push({ from: 'MCP', to: 'AGENT', label: 'MCP ÂçèËÆÆÂìçÂ∫î', data: { jsonrpc: "2.0", result: { content: [{type:"text", text:"Values..."}] } } });
                    seq.push({ from: 'AGENT', to: 'LLM', label: 'Êèê‰∫§ MCP ÁªìÊûú', data: { role: "tool", content: "Values..." } });
                    seq.push({ from: 'LLM', to: 'AGENT', label: 'ÁîüÊàêÂõûÁ≠î', data: { content: "Excel shows..." } });
                    seq.push({ from: 'AGENT', to: 'HOST', label: 'ÂÆåÊàê', data: { final: "Done" } });
                    seq.push({ from: 'HOST', to: 'USER', label: 'ÊòæÁ§∫ÁªìÊûú', data: { output: "Done" } });
                
                } else {
                    return null;
                }
                return seq;
            };

            const validateAndStart = () => {
                let error = null;
                if (config.mcp && !config.fc) error = "ÁªÑÂêàÊó†Êïà: MCP ÂøÖÈ°ª‰æùËµñ Function Calling„ÄÇ";
                else if (config.mcp && !config.agent) error = "ÁªÑÂêàÊó†Êïà (ÊºîÁ§∫ÈôêÂà∂): Ê≠§ÊºîÁ§∫‰∏≠ MCP ÈúÄÊåÇËΩΩ‰∫é Agent„ÄÇ";
                else if (config.agent && !config.fc) error = "ÁªÑÂêà‰∏çÂ≠òÂú®: Agent ÈúÄË¶Å Function Calling ÊâçËÉΩË°åÂä®„ÄÇ";

                if (error) {
                    setErrorMsg(error);
                    setIsPlaying(false);
                    setSequence([]);
                    return;
                }

                setErrorMsg(null);
                const seq = generateSequence(config);
                setSequence(seq);
                setCurrentStepIndex(-1);
                setIsPlaying(true);

                // === ‰ºòÂåñÂÖ≥ÈîÆÁÇπÔºöÈáçÊéíÊ≥≥ÈÅìÈ°∫Â∫è ===
                // ÈÅµÂæ™ "ÈÄö‰ø°‰∫≤ÂØÜÂ∫¶" ÂéüÂàôÔºöUser -> Host -> Agent -> LLM -> MCP -> Tools
                // ËøôÊ†∑ Host Âíå Agent Áõ∏ÈÇªÔºåAgent Âíå LLM Áõ∏ÈÇªÔºåÂáèÂ∞ëË∑®Á∫ø„ÄÇ
                const MASTER_ORDER = ['USER', 'HOST', 'AGENT', 'LLM', 'MCP', 'TOOLS'];
                
                const activeSet = new Set(['USER', 'HOST', 'LLM']);
                if (config.agent) activeSet.add('AGENT');
                if (config.mcp) activeSet.add('MCP');
                if (config.fc) activeSet.add('TOOLS');
                
                // ÊåâÁÖß MASTER_ORDER ÁöÑÈ°∫Â∫èËøáÊª§Âá∫ÂΩìÂâçÊøÄÊ¥ªÁöÑÊ≥≥ÈÅì
                const active = MASTER_ORDER.filter(id => activeSet.has(id));
                
                setActiveLifelines(active);
            };

            useEffect(() => {
                if (isPlaying && sequence.length > 0) {
                    if (currentStepIndex < sequence.length - 1) {
                        const timer = setTimeout(() => {
                            setCurrentStepIndex(prev => prev + 1);
                        }, 1200); 
                        return () => clearTimeout(timer);
                    } else {
                        setTimeout(() => setIsPlaying(false), 1000);
                    }
                }
            }, [isPlaying, currentStepIndex, sequence]);

            const getLifelinePosition = (id) => {
                const active = activeLifelines;
                const index = active.indexOf(id);
                if (index === -1) return -1;
                return (index + 0.5) * (100 / active.length);
            };

            // ËÆ°ÁÆóÂä®ÊÄÅÈ´òÂ∫¶
            const containerHeight = `${(currentStepIndex + 5) * 100}px`;

            return (
                <div className="h-screen flex flex-col overflow-hidden bg-slate-900">
                    {/* Header */}
                    <div className="bg-slate-950 border-b border-slate-800 p-4 z-20 shadow-lg shrink-0">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                                    <span className="text-3xl">‚ö°</span> AI Êû∂ÊûÑÊó∂Â∫èÊ®°ÊãüÂô®
                                </h1>
                            </div>
                            
                            <div className="flex items-center gap-4 bg-slate-900 px-5 py-3 rounded-lg border border-slate-800">
                                <div className="flex gap-3 text-sm text-slate-400 border-r border-slate-700 pr-3 font-semibold">
                                    <label className="flex items-center gap-2 cursor-not-allowed opacity-50"><input type="checkbox" checked disabled className="w-4 h-4 accent-blue-500"/> Host</label>
                                    <label className="flex items-center gap-2 cursor-not-allowed opacity-50"><input type="checkbox" checked disabled className="w-4 h-4 accent-green-500"/> LLM</label>
                                </div>
                                <div className="flex gap-4 text-base font-bold text-white">
                                    <label className="flex items-center gap-2 cursor-pointer hover:text-purple-300"><input type="checkbox" checked={config.agent} onChange={e => setConfig({...config, agent: e.target.checked})} className="w-4 h-4 accent-purple-500"/> Agent</label>
                                    <label className="flex items-center gap-2 cursor-pointer hover:text-yellow-300"><input type="checkbox" checked={config.fc} onChange={e => setConfig({...config, fc: e.target.checked})} className="w-4 h-4 accent-yellow-500"/> Func Call</label>
                                    <label className="flex items-center gap-2 cursor-pointer hover:text-orange-300"><input type="checkbox" checked={config.mcp} onChange={e => setConfig({...config, mcp: e.target.checked})} className="w-4 h-4 accent-orange-500"/> MCP</label>
                                </div>
                                <button onClick={validateAndStart} disabled={isPlaying} className={`ml-4 px-5 py-2 rounded-lg font-bold text-base ${isPlaying ? 'bg-slate-700 text-slate-400' : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg hover:scale-105 transition-transform'}`}>
                                    {isPlaying ? 'ËøêË°å‰∏≠...' : '‚ñ∂ ËøêË°å'}
                                </button>
                            </div>
                        </div>
                    </div>

                    {errorMsg && <div className="bg-red-900/50 text-red-200 p-2 text-center text-sm font-bold">{errorMsg}</div>}

                    {/* Content Area */}
                    <div className="flex-1 flex overflow-hidden">
                        
                        {/* Left: Diagram (Scrollable) */}
                        <div className="flex-1 relative bg-slate-900 overflow-y-auto custom-scroll" ref={scrollRef}>
                            <div className="relative pb-20 transition-all duration-500 ease-out" style={{ height: containerHeight, minHeight: '100%' }}>
                                
                                {/* 1. Ê≥≥ÈÅìËÉåÊôØ (Ë¥ØÁ©øÊï¥‰∏™Âä®ÊÄÅÈ´òÂ∫¶) */}
                                {activeLifelines.map(id => {
                                    const entity = ENTITIES[id];
                                    const pos = getLifelinePosition(id);
                                    return (
                                        <div key={id} className="absolute top-0 bottom-0 flex flex-col items-center" style={{ left: `${pos}%`, transform: 'translateX(-50%)' }}>
                                            <div className="sticky top-0 z-20 pt-4 pb-2 bg-slate-900 w-full flex justify-center">
                                                <div className={`px-4 py-2 rounded-lg border bg-slate-800 shadow-xl flex flex-col items-center w-28 text-center text-sm font-bold ${entity.color}`}>
                                                    <div className="text-2xl mb-1">{entity.icon}</div>
                                                    <div className="truncate w-full">{entity.name}</div>
                                                </div>
                                            </div>
                                            {/* Ê≥≥ÈÅìËôöÁ∫ø */}
                                            <div className={`w-0.5 flex-1 border-l-2 border-dashed border-slate-700 opacity-40`}></div>
                                        </div>
                                    );
                                })}

                                {/* 2. Ê≠•È™§Ê∏≤Êüì */}
                                {sequence.map((step, idx) => {
                                    if (idx > currentStepIndex) return null; 
                                    
                                    const isCurrent = idx === currentStepIndex;
                                    const startPos = getLifelinePosition(step.from);
                                    const endPos = getLifelinePosition(step.to);
                                    const isLeftToRight = endPos > startPos;
                                    const width = Math.abs(endPos - startPos);
                                    const left = Math.min(startPos, endPos);
                                    
                                    const top = 100 + idx * 80;

                                    return (
                                        <div key={idx} className="absolute w-full" style={{ top: `${top}px`, height: '80px' }}>
                                            {/* Ëá™ÁéØÁöÑÊÉÖÂÜµ */}
                                            {step.from === step.to ? (
                                                <div className="absolute flex flex-col items-center" style={{ left: `${startPos}%`, transform: 'translateX(-50%)' }}>
                                                    <div className={`text-xs font-bold p-2 rounded border ${isCurrent ? 'bg-yellow-900/50 border-yellow-500 text-yellow-200' : 'bg-slate-800 border-slate-600 text-slate-300'} transition-all duration-500`}>
                                                        ‚ü≥ {step.label}
                                                    </div>
                                                </div>
                                            ) : (
                                                // Ê≠£Â∏∏ÁÆ≠Â§¥
                                                <div className="absolute" style={{ left: `${left}%`, width: `${width}%` }}>
                                                    <Arrow 
                                                        widthPercent={100} 
                                                        isLeftToRight={isLeftToRight} 
                                                        label={step.label} 
                                                        isCurrent={isCurrent}
                                                        index={idx}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Right: Logs */}
                        <div className="w-96 bg-slate-950 border-l border-slate-800 flex flex-col z-30 shrink-0">
                            <div className="p-3 border-b border-slate-800 bg-slate-900 text-sm font-bold text-slate-300 uppercase flex justify-between items-center">
                                <span>Êï∞ÊçÆÂåÖÊó•Âøó (Payload Log)</span>
                                <button onClick={()=>setSequence([])} className="text-slate-500 hover:text-white px-2 py-1 border border-slate-700 rounded text-xs">Ê∏ÖÈô§</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-3 custom-scroll space-y-3 font-mono text-xs">
                                {sequence.slice(0, currentStepIndex + 1).map((step, idx) => (
                                    <div key={idx} className={`rounded border p-3 transition-all duration-500 ${idx === currentStepIndex ? 'bg-slate-900 border-yellow-500/50 shadow-lg ring-1 ring-yellow-500/20' : 'bg-slate-900/60 border-slate-700'}`}>
                                        <div className="flex items-center gap-2 mb-2 text-slate-400 font-bold">
                                            <span className="bg-slate-800 px-2 rounded text-white">{idx + 1}</span>
                                            <span className={`${ENTITIES[step.from].color}`}>{step.from}</span>
                                            <span className="text-slate-600">‚ûî</span>
                                            <span className={`${ENTITIES[step.to].color}`}>{step.to}</span>
                                        </div>
                                        <div className="text-slate-300 overflow-x-auto bg-slate-950 p-2 rounded border border-slate-800">
                                            <pre className="text-xs leading-relaxed">{JSON.stringify(step.data, null, 2)}</pre>
                                        </div>
                                    </div>
                                ))}
                                {currentStepIndex === -1 && <div className="text-center text-slate-600 mt-20 text-sm">ËØ∑ÈÖçÁΩÆÂπ∂ÁÇπÂáªËøêË°å...</div>}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>