# TopFac è„šæœ¬è¯´æ˜

æœ¬ç›®å½•åŒ…å«TopFacé¡¹ç›®çš„å„ç§è¿ç»´å’Œéƒ¨ç½²è„šæœ¬ã€‚

---

## ğŸ“ è„šæœ¬åˆ—è¡¨

### ğŸ”’ å®‰å…¨ä¸æ—¥å¿—ç›¸å…³

#### 1. `analyze-user-agent.sh`
**ç”¨é€”**: åˆ†æJSONæ—¥å¿—ä¸­çš„User-Agentï¼Œè¯†åˆ«æ­£å¸¸ç”¨æˆ·ã€çˆ¬è™«ã€æ‰«æå™¨ç­‰

**ä½¿ç”¨æ–¹æ³•**:
```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh root@8.211.149.80 '/usr/local/bin/analyze-user-agent.sh'

# æˆ–æœ¬åœ°è¿è¡Œï¼ˆéœ€è¦SSHè®¿é—®æƒé™ï¼‰
./scripts/analyze-user-agent.sh
```

**åŠŸèƒ½**:
- ç»Ÿè®¡è¯·æ±‚ç±»å‹ï¼ˆæµè§ˆå™¨ã€ç§»åŠ¨è®¾å¤‡ã€çˆ¬è™«ã€æ‰«æå™¨ï¼‰
- åˆ†æå¯ç–‘è¯·æ±‚ï¼ˆ400/403/404é”™è¯¯ï¼‰
- æ˜¾ç¤ºTop 10 User-Agentå’Œè®¿é—®IP
- æ€§èƒ½ç»Ÿè®¡ï¼ˆå¹³å‡å“åº”æ—¶é—´ã€æ…¢è¯·æ±‚ï¼‰
- å®‰å…¨å»ºè®®

**å®šæ—¶ä»»åŠ¡**:
```bash
# æ¯å¤©æ—©ä¸Š9ç‚¹è¿è¡Œ
0 9 * * * /usr/local/bin/analyze-user-agent.sh > /var/log/ua-analysis.log
```

---

#### 2. `deploy-json-logger.sh`
**ç”¨é€”**: éƒ¨ç½²JSONæ—¥å¿—ç³»ç»Ÿåˆ°OpenRestyæœåŠ¡å™¨

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/deploy-json-logger.sh
```

**åŠŸèƒ½**:
- å¤‡ä»½ç°æœ‰é…ç½®
- ä¸Šä¼ Luaæ—¥å¿—æ¨¡å—ï¼ˆlogger.lua, log_buffer.luaï¼‰
- æ›´æ–°nginx.confå’Œtopfacé…ç½®
- æµ‹è¯•å¹¶é‡è½½Nginx

**éƒ¨ç½²å†…å®¹**:
- JSONæ—¥å¿—å®æ—¶è¾“å‡º
- æŒ‰å¤©è‡ªåŠ¨åˆ†å‰²æ—¥å¿—æ–‡ä»¶
- æ‰¹é‡å†™å…¥ä¼˜åŒ–ï¼ˆ1000æ¡æˆ–5ç§’ï¼‰
- è‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™180å¤©ï¼‰

---

#### 3. `deploy-security-rules.sh`
**ç”¨é€”**: éƒ¨ç½²å®‰å…¨é˜²æŠ¤è§„åˆ™

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/deploy-security-rules.sh
```

**åŠŸèƒ½**:
- é˜»æ­¢æ— User-Agentçš„è¯·æ±‚ï¼ˆè¿”å›403ï¼‰
- é˜»æ­¢å·²çŸ¥æ‰«æå™¨ï¼ˆzgrabã€masscanã€nmapç­‰ï¼‰
- å…¨å±€é™æµï¼šæ¯IPæ¯ç§’50ä¸ªè¯·æ±‚
- APIé™æµï¼šæ¯IPæ¯ç§’10ä¸ªè¯·æ±‚

**éªŒè¯**:
```bash
# æµ‹è¯•æ— User-Agentè¯·æ±‚ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
curl -H "User-Agent:" -v https://topfac.nssa.io/

# æµ‹è¯•æ­£å¸¸è¯·æ±‚ï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -A 'Mozilla/5.0' https://topfac.nssa.io/
```

---

#### 4. `test-json-logger.sh`
**ç”¨é€”**: æµ‹è¯•JSONæ—¥å¿—ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/test-json-logger.sh
```

**æµ‹è¯•é¡¹ç›®**:
- âœ“ æ£€æŸ¥Luaæ¨¡å—æ˜¯å¦å­˜åœ¨
- âœ“ æ£€æŸ¥æ—¥å¿—ç›®å½•æƒé™
- âœ“ æ£€æŸ¥Nginxé…ç½®
- âœ“ å‘é€æµ‹è¯•è¯·æ±‚
- âœ“ éªŒè¯JSONæ—¥å¿—æ–‡ä»¶
- âœ“ éªŒè¯JSONæ ¼å¼
- âœ“ éªŒè¯æ—¥å¿—å­—æ®µå®Œæ•´æ€§

---

### ğŸš€ åº”ç”¨éƒ¨ç½²ç›¸å…³

#### 5. `deploy.sh`
**ç”¨é€”**: TopFacæœ¬åœ°ç‰ˆDockerå®¹å™¨åŒ–éƒ¨ç½²

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/deploy.sh
```

**åŠŸèƒ½**:
- æ£€æŸ¥Dockerç¯å¢ƒ
- æ„å»ºDockeré•œåƒ
- åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨
- é…ç½®æ•°æ®æŒä¹…åŒ–
- å¥åº·æ£€æŸ¥

**é€‚ç”¨åœºæ™¯**: æœ¬åœ°å¼€å‘ã€æµ‹è¯•ç¯å¢ƒ

---

#### 6. `dev.sh`
**ç”¨é€”**: å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆå‰åç«¯å¹¶è¡Œï¼‰

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/dev.sh
```

**åŠŸèƒ½**:
- æ£€æŸ¥Node.jsç‰ˆæœ¬ï¼ˆéœ€è¦18+ï¼‰
- è‡ªåŠ¨å®‰è£…ä¾èµ–
- å¹¶è¡Œå¯åŠ¨å‰ç«¯ï¼ˆNuxtï¼‰å’Œåç«¯ï¼ˆExpressï¼‰
- æ”¯æŒçƒ­é‡è½½

**è®¿é—®åœ°å€**:
- å‰ç«¯: http://localhost:3000
- åç«¯API: http://localhost:3000/api

---

#### 7. `start-prod.sh`
**ç”¨é€”**: å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/start-prod.sh
```

**åŠŸèƒ½**:
- æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
- è‡ªåŠ¨æ„å»ºå‰ç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
- å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
- PM2è¿›ç¨‹ç®¡ç†

**å‰ç½®æ¡ä»¶**:
- å·²é…ç½®.envæ–‡ä»¶
- å·²æ„å»ºå‰ç«¯ï¼ˆæˆ–è‡ªåŠ¨æ„å»ºï¼‰

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: é¦–æ¬¡éƒ¨ç½²JSONæ—¥å¿—ç³»ç»Ÿ
```bash
# 1. éƒ¨ç½²JSONæ—¥å¿—
./scripts/deploy-json-logger.sh

# 2. æµ‹è¯•æ—¥å¿—ç³»ç»Ÿ
./scripts/test-json-logger.sh

# 3. éƒ¨ç½²å®‰å…¨è§„åˆ™
./scripts/deploy-security-rules.sh

# 4. åˆ†ææ—¥å¿—
ssh root@8.211.149.80 '/usr/local/bin/analyze-user-agent.sh'
```

### åœºæ™¯2: æ—¥å¸¸å®‰å…¨ç›‘æ§
```bash
# æ¯å¤©è¿è¡Œåˆ†æè„šæœ¬
./scripts/analyze-user-agent.sh

# æŸ¥çœ‹è¢«æ‹’ç»çš„è¯·æ±‚
ssh root@8.211.149.80 'grep "\"status\":403" /var/log/openresty/json/access-$(date +%Y%m%d).json | jq .'
```

### åœºæ™¯3: æœ¬åœ°å¼€å‘
```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
./scripts/dev.sh

# æˆ–ä½¿ç”¨Docker
./scripts/deploy.sh
```

### åœºæ™¯4: ç”Ÿäº§éƒ¨ç½²
```bash
# å¯åŠ¨ç”Ÿäº§æœåŠ¡
./scripts/start-prod.sh
```

---

## ğŸ”§ ç»´æŠ¤å»ºè®®

### å®šæœŸä»»åŠ¡

1. **æ¯å¤©**: è¿è¡Œ`analyze-user-agent.sh`åˆ†æå®‰å…¨çŠ¶å†µ
2. **æ¯å‘¨**: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°å’Œç£ç›˜ä½¿ç”¨
3. **æ¯æœˆ**: å®¡æŸ¥è¢«æ‹’ç»çš„è¯·æ±‚ï¼Œè°ƒæ•´å®‰å…¨è§„åˆ™

### ç›‘æ§æŒ‡æ ‡

- ç£ç›˜ä½¿ç”¨ç‡ï¼ˆæ—¥å¿—ç›®å½•ï¼‰
- 403é”™è¯¯æ•°é‡ï¼ˆè¢«æ‹’ç»çš„è¯·æ±‚ï¼‰
- æ‰«æå™¨è¯·æ±‚æ•°é‡
- å¹³å‡å“åº”æ—¶é—´

### å‘Šè­¦é˜ˆå€¼

- âš ï¸ ç£ç›˜ä½¿ç”¨ç‡ > 80%
- âš ï¸ 403é”™è¯¯ > 100/å¤©
- âš ï¸ æ‰«æå™¨è¯·æ±‚ > 50/å¤©
- âš ï¸ å¹³å‡å“åº”æ—¶é—´ > 1ç§’

---

## ğŸ“ è„šæœ¬ä¾èµ–

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu/Debian)
- **Shell**: Bash 4.0+
- **SSH**: éœ€è¦root@8.211.149.80çš„SSHè®¿é—®æƒé™

### è½¯ä»¶ä¾èµ–

- **OpenResty**: 1.19+
- **jq**: JSONå¤„ç†å·¥å…·
- **Node.js**: 18+ (ä»…å¼€å‘/ç”Ÿäº§è„šæœ¬)
- **Docker**: 20+ (ä»…deploy.sh)

### å®‰è£…ä¾èµ–

```bash
# Ubuntu/Debian
sudo apt-get install -y jq

# æ£€æŸ¥OpenResty
/usr/local/openresty/nginx/sbin/nginx -v

# æ£€æŸ¥Node.js
node -v
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜1: JSONæ—¥å¿—æ–‡ä»¶æœªç”Ÿæˆ

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ç›®å½•æƒé™
ssh root@8.211.149.80 'ls -ld /var/log/openresty/json/'

# 2. æ£€æŸ¥é”™è¯¯æ—¥å¿—
ssh root@8.211.149.80 'tail -50 /var/log/openresty/error.log | grep -i logger'

# 3. æ£€æŸ¥Luaæ¨¡å—
ssh root@8.211.149.80 'ls -l /usr/local/openresty/lualib/custom/'
```

### é—®é¢˜2: å®‰å…¨è§„åˆ™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. æµ‹è¯•é…ç½®
ssh root@8.211.149.80 '/usr/local/openresty/nginx/sbin/nginx -t'

# 2. é‡è½½Nginx
ssh root@8.211.149.80 'systemctl reload openresty'

# 3. æµ‹è¯•è§„åˆ™
curl -H "User-Agent:" -v https://topfac.nssa.io/
```

### é—®é¢˜3: åˆ†æè„šæœ¬æŠ¥é”™

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥jqæ˜¯å¦å®‰è£…
ssh root@8.211.149.80 'which jq'

# 2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ssh root@8.211.149.80 'ls -l /var/log/openresty/json/'

# 3. æ‰‹åŠ¨è¿è¡Œè„šæœ¬æŸ¥çœ‹è¯¦ç»†é”™è¯¯
ssh root@8.211.149.80 'bash -x /usr/local/bin/analyze-user-agent.sh'
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [JSONæ—¥å¿—éƒ¨ç½²æ–‡æ¡£](../docs/json-logger-deployment.md)
- [OpenRestyé…ç½®](../config/openresty/)
- [Luaæ¨¡å—](../config/openresty/lua/)

---

**æœ€åæ›´æ–°**: 2025-10-04  
**ç»´æŠ¤è€…**: TopFac Team

