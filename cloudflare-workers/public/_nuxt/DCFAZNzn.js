import ke from"./Cmus0HHb.js";import Ae from"./DjxpzUX5.js";import Ie from"./4Atq2X6u.js";import $e from"./Dbcok1pe.js";import je from"./cre--wJq.js";import Pe from"./izrBRww7.js";import Se from"./BevbEvyI.js";import{d as De,r as v,k as C,o as Te,P as he,x as m,B as o,z as i,C as n,a as b,g as l,Q as Re,K as Ue,y as _,D as u,A as P,L as M,N as ze,O as Be,M as Ne,R as Ee,_ as Me}from"./Cj1qi_YS.js";import"./BE1C8siA.js";import"./Dv4lo316.js";const Fe={class:"topology-editor"},He={key:0,class:"d-flex justify-center align-center",style:{height:"60vh"}},Le={class:"text-center"},Oe={key:1,class:"text-center pa-12"},We={key:2,class:"editor-container"},Xe={class:"d-flex align-center w-100 px-4"},Ke={class:"text-h6 font-weight-bold"},Qe={class:"text-caption text-grey-darken-1"},qe={key:0,class:"mx-1"},Ge={key:1},Je={class:"d-flex align-center"},Ye={class:"editor-content"},Ze={class:"panel-header"},et={class:"d-flex align-center"},tt={key:0,class:"ai-panel"},ot={class:"text-editor"},nt=De({__name:"[id]",setup(at){const W=Re();Ue();const U=v(!0),z=v(!1),g=v(!1),S=v(null),D=v([]),s=v(null),k=v(""),p=v(""),w=v("preview"),B=v(!1),A=v(!1),x=v(!1),T=v(null),X=v(""),y=v([]),K=C(()=>D.value.map(t=>({title:`v${t.version} - ${E(t.status)}`,value:t._id}))),Q=C(()=>s.value?`v${s.value.version} - ${E(s.value.status)}`:"选择版本"),I=C(()=>W.params.id),N=async()=>{var t;U.value=!0;try{const{$topologyApi:e}=b(),c=await e.projects.getById(I.value);if(!c.data)throw new Error("项目数据加载失败");S.value=c.data;const r=await e.projects.getVersions(I.value);if(!((t=r.data)!=null&&t.versions))throw new Error("项目版本列表加载失败");if(D.value=r.data.versions,D.value.length>0){let d=null;d=D.value[0],console.log("选择最新版本:",d._id,"v"+d.version),k.value=d._id,await V(d._id)}}catch(e){console.error("加载项目失败:",e),S.value=null}finally{U.value=!1}},V=async t=>{if(t)try{const{$topologyApi:e}=b(),c=await e.versions.getById(t);if(!c.data)throw new Error("版本详情加载失败");s.value=c.data,p.value=c.data.text_content||""}catch(e){console.error("加载版本失败:",e)}},q=async t=>{k.value=t,await V(t)},F=async()=>{if(s.value){z.value=!0;try{const{$topologyApi:t}=b();await t.versions.update(s.value._id,{text_content:p.value}),await V(s.value._id)}catch(t){console.error("保存版本失败:",t)}finally{z.value=!1}}},G=async()=>{var t;if(p.value.trim()){console.log("主页面: 开始处理工作流"),g.value=!0,y.value=[],w.value="preview";try{const{$topologyApi:e}=b();console.log("主页面: 调用后端工作流API");const c=p.value.toUpperCase(),r=await e.projects.processWorkflow(I.value,{text_content:c});if(console.log("主页面: 工作流处理完成",r),r.success&&((t=r.data)!=null&&t.version_id)){const d=r.data.processing_steps||[];X.value=r.data.version_id,k.value=r.data.version_id,await N(),await V(r.data.version_id),y.value=d,console.log("主页面: 恢复步骤数据:",y.value),console.log("主页面: 工作流完成，版本ID:",r.data.version_id)}else throw new Error(r.error||"处理失败")}catch(e){console.error("处理工作流失败:",e)}finally{g.value=!1}}};C(()=>{var t;return((t=overallStatus.value)==null?void 0:t.status)==="completed"}),C(()=>y.value.some(t=>t.status==="failed")),C(()=>y.value.reduce((t,e)=>t+(e.duration||0),0));const H=async()=>{var t;if((t=s.value)!=null&&t.xml_content)try{const{$topologyApi:e}=b();await e.download(s.value._id)}catch(e){console.error("下载失败:",e)}},J=()=>{},Y=t=>{console.log("AI转换完成:",t),s.value&&F(),A.value=!1,console.log("AI转换的文本已应用到编辑器")},Z=async t=>{console.log("AI配置保存完成:",t),T.value&&T.value.refreshConfigStatus&&await T.value.refreshConfigStatus(),x.value=!1,console.log("AI配置状态已更新，用户可以继续使用AI转换功能")},E=t=>({draft:"草稿",parsed:"已解析",generated:"已生成",published:"已发布"})[t]||"未知状态",ee=t=>{console.log("预览版本:",t)},te=async t=>{k.value=t._id,await V(t._id),w.value="preview"},oe=async()=>{if(p.value.trim())try{const{$topologyApi:t}=b(),e=p.value.toUpperCase(),c=await t.projects.createVersion(I.value,{text_content:e});await N(),k.value=c.data._id,await V(c.data._id)}catch(t){console.error("创建版本失败:",t)}};return Te(()=>{console.log("页面挂载，开始加载项目数据..."),N()}),he(p,(t,e)=>{}),(t,e)=>{const c=l("v-progress-circular"),r=l("v-icon"),d=l("v-btn"),L=l("v-spacer"),ne=l("v-list-item-title"),ae=l("v-list-item"),le=l("v-list"),se=l("v-menu"),re=l("v-tooltip"),ie=l("v-app-bar"),de=ke,ue=l("v-textarea"),O=l("v-col"),h=l("v-tab"),ve=l("v-tabs"),ce=Ae,R=l("v-tabs-window-item"),pe=Ie,_e=$e,me=je,fe=l("v-tabs-window"),ge=l("v-row"),we=Pe,xe=l("v-card-title"),ye=Se,Ve=l("v-card-text"),Ce=l("v-card"),be=l("v-dialog");return _(),m("div",Fe,[U.value?(_(),m("div",He,[i("div",Le,[o(c,{indeterminate:"",color:"primary",size:"64"}),e[13]||(e[13]=i("p",{class:"text-body-1 text-grey-darken-1 mt-4"},"加载项目中...",-1))])])):S.value?(_(),m("div",We,[o(ie,{color:"white",elevation:"1",height:"64",class:"editor-toolbar"},{default:n(()=>{var a,$,j;return[i("div",Xe,[o(d,{icon:"mdi-arrow-left",variant:"text",class:"mr-3",onClick:e[1]||(e[1]=f=>t.$router.push("/topology-projects"))}),o(r,{class:"mr-2",color:"primary"},{default:n(()=>e[18]||(e[18]=[u("mdi-sitemap")])),_:1,__:[18]}),i("div",null,[i("div",Ke,P(S.value.project_name),1),i("div",Qe,[u(" 当前版本：v"+P(((a=s.value)==null?void 0:a.version)||0)+" ",1),($=s.value)!=null&&$.status?(_(),m("span",qe,"•")):M("",!0),(j=s.value)!=null&&j.status?(_(),m("span",Ge,P(E(s.value.status)),1)):M("",!0)])]),o(L),i("div",Je,[o(se,null,{activator:n(({props:f})=>[o(d,Ee({variant:"outlined",class:"mr-3 version-selector-btn"},f,{"append-icon":"mdi-chevron-down"}),{default:n(()=>[u(P(Q.value),1)]),_:2},1040)]),default:n(()=>[o(le,{density:"compact","min-width":"200"},{default:n(()=>[(_(!0),m(ze,null,Be(K.value,f=>(_(),Ne(ae,{key:f.value,value:f.value,onClick:lt=>q(f.value)},{default:n(()=>[o(ne,null,{default:n(()=>[u(P(f.title),1)]),_:2},1024)]),_:2},1032,["value","onClick"]))),128))]),_:1})]),_:1}),o(d,{variant:"outlined","prepend-icon":"mdi-content-save",class:"mr-3",loading:z.value,onClick:F},{default:n(()=>e[19]||(e[19]=[u(" 保存 ")])),_:1,__:[19]},8,["loading"]),o(d,{icon:"",color:"primary",size:"large",class:"generate-btn",loading:g.value,onClick:G},{default:n(()=>[o(r,{size:"24"},{default:n(()=>e[20]||(e[20]=[u("mdi-play")])),_:1,__:[20]}),o(re,{activator:"parent",location:"bottom"},{default:n(()=>e[21]||(e[21]=[u(" 生成拓扑图 ")])),_:1,__:[21]})]),_:1},8,["loading"])])])]}),_:1}),i("div",Ye,[o(ge,{"no-gutters":"",style:{height:"100%"}},{default:n(()=>[o(O,{cols:"12",lg:"4",class:"editor-panel"},{default:n(()=>[i("div",Ze,[e[24]||(e[24]=i("h3",{class:"text-h6 font-weight-bold"},"拓扑文本编辑",-1)),i("div",et,[o(d,{variant:"text",size:"small","prepend-icon":"mdi-robot",onClick:e[2]||(e[2]=a=>A.value=!A.value),color:A.value?"primary":"default"},{default:n(()=>e[22]||(e[22]=[u(" AI转换 ")])),_:1,__:[22]},8,["color"]),o(d,{variant:"text",size:"small","prepend-icon":"mdi-help-circle-outline",onClick:e[3]||(e[3]=a=>B.value=!0)},{default:n(()=>e[23]||(e[23]=[u(" 格式说明 ")])),_:1,__:[23]})])]),A.value?(_(),m("div",tt,[o(de,{ref_key:"aiConversionPanelRef",ref:T,modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=a=>p.value=a),onConverted:Y,onOpenConfig:e[5]||(e[5]=a=>x.value=!0)},null,8,["modelValue"])])):M("",!0),i("div",ot,[o(ue,{modelValue:p.value,"onUpdate:modelValue":e[6]||(e[6]=a=>p.value=a),placeholder:"请输入网络拓扑描述文本...",variant:"outlined","hide-details":"",rows:"25","auto-grow":"",class:"editor-textarea",onInput:J},null,8,["modelValue"])])]),_:1}),o(O,{cols:"12",lg:"8",class:"preview-panel"},{default:n(()=>[e[29]||(e[29]=i("div",{class:"panel-header"},[i("h3",{class:"text-h6 font-weight-bold"},"预览和结果"),i("div",{class:"d-flex align-center"})],-1)),o(ve,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=a=>w.value=a),class:"preview-tabs"},{default:n(()=>[o(h,{value:"preview"},{default:n(()=>e[25]||(e[25]=[u("拓扑生成")])),_:1,__:[25]}),o(h,{value:"data"},{default:n(()=>e[26]||(e[26]=[u("解析数据")])),_:1,__:[26]}),o(h,{value:"xml"},{default:n(()=>e[27]||(e[27]=[u("XML代码")])),_:1,__:[27]}),o(h,{value:"history"},{default:n(()=>e[28]||(e[28]=[u("版本历史")])),_:1,__:[28]})]),_:1},8,["modelValue"]),o(fe,{modelValue:w.value,"onUpdate:modelValue":e[8]||(e[8]=a=>w.value=a),class:"preview-content"},{default:n(()=>[o(R,{value:"preview",class:"preview-tab"},{default:n(()=>{var a,$,j;return[o(ce,{"xml-content":(a=s.value)==null?void 0:a.xml_content,"parsed-data":($=s.value)==null?void 0:$.parsed_data,loading:g.value,"version-id":(j=s.value)==null?void 0:j._id,"processing-steps":y.value,onDownload:H},null,8,["xml-content","parsed-data","loading","version-id","processing-steps"])]}),_:1}),o(R,{value:"data",class:"data-tab"},{default:n(()=>{var a;return[o(pe,{"parsed-data":(a=s.value)==null?void 0:a.parsed_data,loading:g.value},null,8,["parsed-data","loading"])]}),_:1}),o(R,{value:"xml",class:"xml-tab"},{default:n(()=>{var a;return[o(_e,{"xml-content":(a=s.value)==null?void 0:a.xml_content,loading:g.value,onDownload:H},null,8,["xml-content","loading"])]}),_:1}),o(R,{value:"history",class:"history-tab"},{default:n(()=>{var a;return[o(me,{"project-id":I.value,"current-version-id":(a=s.value)==null?void 0:a._id,onVersionSelected:ee,onVersionSwitched:te,onNewVersionCreated:oe},null,8,["project-id","current-version-id"])]}),_:1})]),_:1},8,["modelValue"])]),_:1,__:[29]})]),_:1})])])):(_(),m("div",Oe,[o(r,{size:"80",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>e[14]||(e[14]=[u(" mdi-folder-remove-outline ")])),_:1,__:[14]}),e[16]||(e[16]=i("h3",{class:"text-h5 text-grey-darken-1 mb-2"},"项目不存在",-1)),e[17]||(e[17]=i("p",{class:"text-body-1 text-grey-darken-1 mb-4"}," 请检查项目ID是否正确，或者项目可能已被删除 ",-1)),o(d,{color:"primary",variant:"outlined","prepend-icon":"mdi-arrow-left",onClick:e[0]||(e[0]=a=>t.$router.push("/topology-projects"))},{default:n(()=>e[15]||(e[15]=[u(" 返回项目列表 ")])),_:1,__:[15]})])),o(we,{modelValue:B.value,"onUpdate:modelValue":e[9]||(e[9]=a=>B.value=a)},null,8,["modelValue"]),o(be,{modelValue:x.value,"onUpdate:modelValue":e[12]||(e[12]=a=>x.value=a),"max-width":"800px",persistent:""},{default:n(()=>[o(Ce,null,{default:n(()=>[o(xe,{class:"d-flex align-center"},{default:n(()=>[o(r,{icon:"mdi-cog",class:"mr-2"}),e[30]||(e[30]=u(" AI配置管理 ")),o(L),o(d,{icon:"mdi-close",variant:"text",onClick:e[10]||(e[10]=a=>x.value=!1)})]),_:1,__:[30]}),o(Ve,{class:"pa-6"},{default:n(()=>[o(ye,{onClose:e[11]||(e[11]=a=>x.value=!1),onConfigSaved:Z})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),ft=Me(nt,[["__scopeId","data-v-58d640f9"]]);export{ft as default};
