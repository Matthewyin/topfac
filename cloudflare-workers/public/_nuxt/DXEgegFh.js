import{d as H,r as h,k as Y,P as w,Y as q,x as d,z as o,L as v,B as g,C as m,N as G,O as K,A as p,D as c,g as S,y as r,V as C,M as P,a as D,_ as Q}from"./v6kkaCau.js";const R=window.setInterval,W={class:"topology-preview"},Z={key:0,class:"preview-with-workflow"},ee={class:"workflow-header-section"},te={class:"workflow-container"},se={class:"workflow-header"},oe={class:"workflow-steps-horizontal"},ne={class:"step-indicator-horizontal"},le=["onClick","onMouseenter","onMouseleave"],ae={class:"step-content-horizontal"},re={class:"step-title-horizontal"},ie={class:"step-description-horizontal"},de={key:0,class:"step-hover-info"},ce={class:"hover-info-container"},pe={class:"hover-info-header"},ue={class:"text-body-2 font-weight-bold"},me={class:"hover-info-content"},ge={key:0,class:"step-detail"},_e={class:"text-body-2 mb-2"},ve={key:0,class:"text-body-2 mb-2"},fe={key:1,class:"text-body-2 mb-2"},ye={key:2,class:"step-data"},he={class:"step-data-content"},we={key:1,class:"step-detail"},xe={class:"text-body-2 mb-2"},ke={class:"text-body-2"},be={key:2,class:"step-detail"},Se={class:"text-body-2 mb-2"},Ce={key:0,class:"text-body-2 text-error"},Ie={key:3,class:"step-detail"},ze={class:"text-body-2 mb-2"},Te={class:"text-body-2"},Ne={class:"preview-content-container"},Pe={key:0,class:"result-section-simple"},De={class:"result-header"},Me={key:1,class:"preview-empty"},Oe={class:"text-center pa-12"},$e=H({__name:"TopologyPreview",props:{xmlContent:{},loading:{type:Boolean},parsedData:{},processingSteps:{},versionId:{}},emits:["download","stepClicked"],setup(M,{emit:O}){const s=M,I=O,z=h(!1),x=h([]),u=h(null),k=h(0),i=h(null),f=[{name:"validation",displayName:"验证格式",description:"检查文本格式和语法"},{name:"local_parsing",displayName:"本地解析",description:"本地文本解析和结构化"},{name:"data_processing",displayName:"处理返回数据",description:"解析结构化数据"},{name:"xml_generation",displayName:"生成拓扑图",description:"转换为XML格式"},{name:"download",displayName:"完成",description:"文件下载"}],b=Y(()=>{if(k.value,s.loading&&(!s.processingSteps||s.processingSteps.length===0))return console.log("TopologyPreview: 检测到加载状态且无步骤数据，重置为pending状态"),f.map(e=>({...e,status:"pending",error_message:null,processing_time_ms:null,started_at:null,completed_at:null,realStepData:null}));if(!s.loading&&s.xmlContent&&(!s.processingSteps||s.processingSteps.length===0))return console.log("TopologyPreview: 工作流已完成但无步骤数据，显示所有步骤为已完成"),f.map((e,n)=>{var a;const y=new Date(Date.now()-(f.length-n-1)*1e3).toISOString();let l={};switch(e.name){case"validation":l={message:"文本格式验证通过",lines_validated:9};break;case"local_parsing":l={message:"本地解析完成",components_parsed:10,connections_parsed:9};break;case"data_processing":l={message:"数据处理完成",data_structured:!0};break;case"xml_generation":l={message:"XML生成完成",xml_length:((a=s.xmlContent)==null?void 0:a.length)||0};break;case"download":l={message:"拓扑图生成完成，可以下载",file_format:"DrawIO XML"};break}return{...e,status:"completed",error_message:null,processing_time_ms:200+n*100,started_at:new Date(Date.now()-(f.length-n)*1e3).toISOString(),completed_at:y,realStepData:{step_name:e.name,status:"completed",step_detail:l}}});const t=s.processingSteps&&s.processingSteps.length>0?s.processingSteps:x.value;return console.log("TopologyPreview: 使用数据源:",s.processingSteps&&s.processingSteps.length>0?"主页面数据":"组件内部数据"),console.log("TopologyPreview: 步骤数据长度:",t.length),t.length>0&&console.log("TopologyPreview: 步骤状态:",t.map(e=>`${e.step_name}:${e.status}`).join(", ")),f.map(e=>{var a;const n=t.find(_=>_.step_name===e.name);let y=(n==null?void 0:n.status)||"pending",l=n;if(e.name==="download"&&!s.loading&&s.xmlContent&&(y="completed",!n)){const _=new Date().toISOString();l={step_name:"download",status:"completed",started_at:_,completed_at:_,processing_time_ms:50,step_detail:{message:"拓扑图生成完成，可以下载",xml_length:((a=s.xmlContent)==null?void 0:a.length)||0,file_format:"DrawIO XML"}}}return{...e,status:y,error_message:l==null?void 0:l.error_message,processing_time_ms:l==null?void 0:l.processing_time_ms,started_at:l==null?void 0:l.started_at,completed_at:l==null?void 0:l.completed_at,realStepData:l}})}),$=t=>({"step-completed":t.status==="completed","step-processing":t.status==="processing","step-pending":t.status==="pending","step-failed":t.status==="failed"}),L=t=>t.name==="download"&&!s.loading&&s.xmlContent?{"step-completed":!0,"step-download":!0,"step-hoverable":!0}:{"step-completed":t.status==="completed","step-processing":t.status==="processing","step-pending":t.status==="pending","step-failed":t.status==="failed","step-hoverable":t.status==="completed"||t.status==="failed"},B=t=>{if(t.name==="download"){if(!s.loading&&s.xmlContent)return"mdi-download";if(t.status==="completed")return"mdi-check";if(t.status==="failed")return"mdi-alert"}if(t.status==="completed")return"mdi-check";if(t.status==="failed")return"mdi-alert";{const e=f.findIndex(n=>n.name===t.name);return String(e+1)}},V=t=>t.name==="download"&&!s.loading&&s.xmlContent||t.status==="completed"||t.status==="processing"||t.status==="failed"?"white":"rgba(0, 0, 0, 0.6)",A=t=>t.status==="processing",X=(t,e)=>t.status==="completed"?"connector-completed":t.status==="processing"?"connector-processing":"connector-pending",J=async()=>{var t;if(s.versionId)try{const{$topologyApi:e}=D(),n=await e.versions.getSteps(s.versionId);n.success&&((t=n.data)!=null&&t.steps)&&(x.value=n.data.steps)}catch(e){console.error("获取步骤数据失败:",e)}},U=()=>{z.value=!0,I("download"),setTimeout(()=>{z.value=!1},1e3)},j=async t=>{if(console.log("步骤点击:",t.name,t),t.name==="download"&&!s.loading&&s.xmlContent){U();return}if(t.status==="completed"&&t.realStepData)try{const{$topologyApi:e}=D(),n=await e.versions.getStepDetail(s.versionId,t.name);n.success&&n.data&&I("stepClicked",t.name,n.data.step_detail)}catch(e){console.error("获取步骤详情失败:",e)}},T=(t,e)=>{e?i.value=t:i.value=null},F=t=>{try{return new Date(t).toLocaleString("zh-CN")}catch{return t}},E=t=>{if(!t)return"无数据";try{if(typeof t=="string"){const e=JSON.parse(t);return JSON.stringify(e,null,2)}return JSON.stringify(t,null,2)}catch{return String(t)}};return w(()=>s.loading,t=>{t&&s.versionId?u.value=R(J,1e4):u.value&&(clearInterval(u.value),u.value=null)},{immediate:!0}),w(()=>s.versionId,t=>{console.log("TopologyPreview: versionId变化:",t)},{immediate:!0}),w(()=>s.processingSteps,(t,e)=>{console.log("TopologyPreview: 监听到主页面步骤数据变化"),console.log("TopologyPreview: 旧数据长度:",(e==null?void 0:e.length)||0),console.log("TopologyPreview: 新数据长度:",(t==null?void 0:t.length)||0),t&&t.length>0?(console.log("TopologyPreview: 新步骤状态:",t.map(n=>`${n.step_name}:${n.status}`).join(", ")),u.value&&(console.log("TopologyPreview: 收到主页面数据，停止内部轮询"),clearInterval(u.value),u.value=null),k.value++,console.log("TopologyPreview: 强制触发UI更新")):t&&t.length===0&&(console.log("TopologyPreview: 主页面数据被重置为空"),k.value++)},{immediate:!0,deep:!0}),w(()=>s.loading,(t,e)=>{console.log("TopologyPreview: loading状态变化:",e,"->",t)},{immediate:!0}),q(()=>{u.value&&clearInterval(u.value)}),(t,e)=>{const n=S("v-icon"),y=S("v-progress-circular"),l=S("v-chip");return r(),d("div",W,[s.loading||s.xmlContent||x.value.length>0?(r(),d("div",Z,[o("div",ee,[o("div",te,[o("div",se,[g(n,{size:"24",color:"primary",class:"mr-2"},{default:m(()=>e[0]||(e[0]=[c("mdi-cog-outline")])),_:1,__:[0]}),e[1]||(e[1]=o("h4",{class:"text-h6 font-weight-bold text-primary"},"拓扑图生成流程",-1))]),o("div",oe,[(r(!0),d(G,null,K(b.value,(a,_)=>(r(),d("div",{key:a.name,class:C(["workflow-step-horizontal",$(a)])},[o("div",ne,[o("div",{class:C(["step-circle-horizontal",L(a)]),onClick:N=>j(a),onMouseenter:N=>T(a,!0),onMouseleave:N=>T(a,!1)},[A(a)?(r(),P(y,{key:1,indeterminate:"",size:"16",width:"2",color:"white"})):(r(),P(n,{key:0,size:16,color:V(a)},{default:m(()=>[c(p(B(a)),1)]),_:2},1032,["color"]))],42,le),_<b.value.length-1?(r(),d("div",{key:0,class:C(["step-connector",X(a,b.value[_+1])])},null,2)):v("",!0)]),o("div",ae,[o("h5",re,p(a.displayName),1),o("p",ie,p(a.description),1)])],2))),128))])]),i.value?(r(),d("div",de,[o("div",ce,[o("div",pe,[g(n,{size:"16",color:"primary",class:"mr-2"},{default:m(()=>e[2]||(e[2]=[c("mdi-information")])),_:1,__:[2]}),o("span",ue,p(i.value.displayName)+" - 详细信息",1)]),o("div",me,[i.value.status==="completed"?(r(),d("div",ge,[o("p",_e,[e[4]||(e[4]=o("strong",null,"状态：",-1)),g(l,{size:"small",color:"success",variant:"flat"},{default:m(()=>e[3]||(e[3]=[c("已完成")])),_:1,__:[3]})]),i.value.processing_time_ms?(r(),d("p",ve,[e[5]||(e[5]=o("strong",null,"处理时间：",-1)),c(p(i.value.processing_time_ms)+"ms ",1)])):v("",!0),i.value.completed_at?(r(),d("p",fe,[e[6]||(e[6]=o("strong",null,"完成时间：",-1)),c(p(F(i.value.completed_at)),1)])):v("",!0),i.value.realStepData?(r(),d("div",ye,[e[7]||(e[7]=o("p",{class:"text-body-2 mb-1"},[o("strong",null,"生成数据：")],-1)),o("pre",he,p(E(i.value.realStepData)),1)])):v("",!0)])):i.value.status==="processing"?(r(),d("div",we,[o("p",xe,[e[9]||(e[9]=o("strong",null,"状态：",-1)),g(l,{size:"small",color:"primary",variant:"flat"},{default:m(()=>e[8]||(e[8]=[c("处理中")])),_:1,__:[8]})]),o("p",ke,"正在执行 "+p(i.value.description)+"...",1)])):i.value.status==="failed"?(r(),d("div",be,[o("p",Se,[e[11]||(e[11]=o("strong",null,"状态：",-1)),g(l,{size:"small",color:"error",variant:"flat"},{default:m(()=>e[10]||(e[10]=[c("失败")])),_:1,__:[10]})]),i.value.error_message?(r(),d("p",Ce,[e[12]||(e[12]=o("strong",null,"错误信息：",-1)),c(p(i.value.error_message),1)])):v("",!0)])):(r(),d("div",Ie,[o("p",ze,[e[14]||(e[14]=o("strong",null,"状态：",-1)),g(l,{size:"small",color:"grey",variant:"flat"},{default:m(()=>e[13]||(e[13]=[c("等待中")])),_:1,__:[13]})]),o("p",Te,p(i.value.description),1)]))])])])):v("",!0)]),o("div",Ne,[!s.loading&&s.xmlContent?(r(),d("div",Pe,[o("div",De,[g(n,{size:"20",color:"success",class:"mr-2"},{default:m(()=>e[15]||(e[15]=[c("mdi-check-circle")])),_:1,__:[15]}),e[16]||(e[16]=o("span",{class:"text-body-2 text-success"},"已生成draw.io格式的网络拓扑图，可直接查看或下载编辑。",-1))])])):v("",!0)])])):(r(),d("div",Me,[o("div",Oe,[g(n,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:m(()=>e[17]||(e[17]=[c(" mdi-sitemap ")])),_:1,__:[17]}),e[18]||(e[18]=o("h4",{class:"text-h6 text-grey-darken-1 mb-2"},"等待生成拓扑图",-1)),e[19]||(e[19]=o("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 请点击生成按钮开始创建拓扑图 ",-1))])]))])}}}),Be=Q($e,[["__scopeId","data-v-4e16b111"]]);export{Be as default};
