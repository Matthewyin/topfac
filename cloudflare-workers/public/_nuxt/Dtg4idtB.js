import be from"./B5GsRgIw.js";import Ce from"./DXEgegFh.js";import ke from"./CxnldWNV.js";import $e from"./B9-Vwjr2.js";import Ae from"./D5NH0T9Q.js";import Ie from"./BnmZNnqu.js";import je from"./CQ2FvyPc.js";import{d as De,r as v,k as V,o as Pe,P as Te,x as m,B as o,z as i,C as n,a as b,g as l,Q as Ue,K as ze,y as _,D as u,A as D,L as E,N as Be,O as Ne,M as Se,R as he,_ as Re}from"./v6kkaCau.js";import"./BB9AC9JM.js";import"./C4H3coZ7.js";const Ee={class:"topology-editor"},Me={key:0,class:"d-flex justify-center align-center",style:{height:"60vh"}},Fe={class:"text-center"},He={key:1,class:"text-center pa-12"},Le={key:2,class:"editor-container"},Oe={class:"d-flex align-center w-100 px-4"},We={class:"text-h6 font-weight-bold"},Xe={class:"text-caption text-grey-darken-1"},Ke={key:0,class:"mx-1"},Qe={key:1},qe={class:"d-flex align-center"},Ge={class:"editor-content"},Je={class:"panel-header"},Ye={class:"d-flex align-center"},Ze={key:0,class:"ai-panel"},et={class:"text-editor"},tt=De({__name:"[id]",setup(ot){const O=Ue();ze();const B=v(!0),N=v(!1),g=v(!1),P=v(null),T=v([]),s=v(null),C=v(""),p=v(""),w=v("preview"),S=v(!1),k=v(!1),$=v(!1),W=v(""),x=v([]),X=V(()=>T.value.map(t=>({title:`v${t.version} - ${R(t.status)}`,value:t._id}))),K=V(()=>s.value?`v${s.value.version} - ${R(s.value.status)}`:"选择版本"),A=V(()=>O.params.id),h=async()=>{var t;B.value=!0;try{const{$topologyApi:e}=b(),c=await e.projects.getById(A.value);if(!c.data)throw new Error("项目数据加载失败");P.value=c.data;const r=await e.projects.getVersions(A.value);if(!((t=r.data)!=null&&t.versions))throw new Error("项目版本列表加载失败");if(T.value=r.data.versions,T.value.length>0){let d=null;d=T.value[0],console.log("选择最新版本:",d._id,"v"+d.version),C.value=d._id,await y(d._id)}}catch(e){console.error("加载项目失败:",e),P.value=null}finally{B.value=!1}},y=async t=>{if(t)try{const{$topologyApi:e}=b(),c=await e.versions.getById(t);if(!c.data)throw new Error("版本详情加载失败");s.value=c.data,p.value=c.data.text_content||""}catch(e){console.error("加载版本失败:",e)}},Q=async t=>{C.value=t,await y(t)},M=async()=>{if(s.value){N.value=!0;try{const{$topologyApi:t}=b();await t.versions.update(s.value._id,{text_content:p.value}),await y(s.value._id)}catch(t){console.error("保存版本失败:",t)}finally{N.value=!1}}},q=async()=>{var t;if(p.value.trim()){console.log("主页面: 开始处理工作流"),g.value=!0,x.value=[],w.value="preview";try{const{$topologyApi:e}=b();console.log("主页面: 调用后端工作流API");const c=p.value.toUpperCase(),r=await e.projects.processWorkflow(A.value,{text_content:c});if(console.log("主页面: 工作流处理完成",r),r.success&&((t=r.data)!=null&&t.version_id)){const d=r.data.processing_steps||[];W.value=r.data.version_id,C.value=r.data.version_id,await h(),await y(r.data.version_id),x.value=d,console.log("主页面: 恢复步骤数据:",x.value),console.log("主页面: 工作流完成，版本ID:",r.data.version_id)}else throw new Error(r.error||"处理失败")}catch(e){console.error("处理工作流失败:",e)}finally{g.value=!1}}};V(()=>{var t;return((t=overallStatus.value)==null?void 0:t.status)==="completed"}),V(()=>x.value.some(t=>t.status==="failed")),V(()=>x.value.reduce((t,e)=>t+(e.duration||0),0));const F=async()=>{var t;if((t=s.value)!=null&&t.xml_content)try{const{$topologyApi:e}=b();await e.download(s.value._id)}catch(e){console.error("下载失败:",e)}},G=()=>{},J=t=>{console.log("AI转换完成:",t),s.value&&M(),k.value=!1,console.log("AI转换的文本已应用到编辑器")},R=t=>({draft:"草稿",parsed:"已解析",generated:"已生成",published:"已发布"})[t]||"未知状态",Y=t=>{console.log("预览版本:",t)},Z=async t=>{C.value=t._id,await y(t._id),w.value="preview"},ee=async()=>{if(p.value.trim())try{const{$topologyApi:t}=b(),e=p.value.toUpperCase(),c=await t.projects.createVersion(A.value,{text_content:e});await h(),C.value=c.data._id,await y(c.data._id)}catch(t){console.error("创建版本失败:",t)}};return Pe(()=>{console.log("页面挂载，开始加载项目数据..."),h()}),Te(p,(t,e)=>{}),(t,e)=>{const c=l("v-progress-circular"),r=l("v-icon"),d=l("v-btn"),H=l("v-spacer"),te=l("v-list-item-title"),oe=l("v-list-item"),ne=l("v-list"),ae=l("v-menu"),le=l("v-tooltip"),se=l("v-app-bar"),re=be,ie=l("v-textarea"),L=l("v-col"),U=l("v-tab"),de=l("v-tabs"),ue=Ce,z=l("v-tabs-window-item"),ve=ke,ce=$e,pe=Ae,_e=l("v-tabs-window"),me=l("v-row"),fe=Ie,ge=l("v-card-title"),we=je,xe=l("v-card-text"),ye=l("v-card"),Ve=l("v-dialog");return _(),m("div",Ee,[B.value?(_(),m("div",Me,[i("div",Fe,[o(c,{indeterminate:"",color:"primary",size:"64"}),e[13]||(e[13]=i("p",{class:"text-body-1 text-grey-darken-1 mt-4"},"加载项目中...",-1))])])):P.value?(_(),m("div",Le,[o(se,{color:"white",elevation:"1",height:"64",class:"editor-toolbar"},{default:n(()=>{var a,I,j;return[i("div",Oe,[o(d,{icon:"mdi-arrow-left",variant:"text",class:"mr-3",onClick:e[1]||(e[1]=f=>t.$router.push("/topology-projects"))}),o(r,{class:"mr-2",color:"primary"},{default:n(()=>e[18]||(e[18]=[u("mdi-sitemap")])),_:1,__:[18]}),i("div",null,[i("div",We,D(P.value.project_name),1),i("div",Xe,[u(" 当前版本：v"+D(((a=s.value)==null?void 0:a.version)||0)+" ",1),(I=s.value)!=null&&I.status?(_(),m("span",Ke,"•")):E("",!0),(j=s.value)!=null&&j.status?(_(),m("span",Qe,D(R(s.value.status)),1)):E("",!0)])]),o(H),i("div",qe,[o(ae,null,{activator:n(({props:f})=>[o(d,he({variant:"outlined",class:"mr-3 version-selector-btn"},f,{"append-icon":"mdi-chevron-down"}),{default:n(()=>[u(D(K.value),1)]),_:2},1040)]),default:n(()=>[o(ne,{density:"compact","min-width":"200"},{default:n(()=>[(_(!0),m(Be,null,Ne(X.value,f=>(_(),Se(oe,{key:f.value,value:f.value,onClick:nt=>Q(f.value)},{default:n(()=>[o(te,null,{default:n(()=>[u(D(f.title),1)]),_:2},1024)]),_:2},1032,["value","onClick"]))),128))]),_:1})]),_:1}),o(d,{variant:"outlined","prepend-icon":"mdi-content-save",class:"mr-3",loading:N.value,onClick:M},{default:n(()=>e[19]||(e[19]=[u(" 保存 ")])),_:1,__:[19]},8,["loading"]),o(d,{icon:"",color:"primary",size:"large",class:"generate-btn",loading:g.value,onClick:q},{default:n(()=>[o(r,{size:"24"},{default:n(()=>e[20]||(e[20]=[u("mdi-play")])),_:1,__:[20]}),o(le,{activator:"parent",location:"bottom"},{default:n(()=>e[21]||(e[21]=[u(" 生成拓扑图 ")])),_:1,__:[21]})]),_:1},8,["loading"])])])]}),_:1}),i("div",Ge,[o(me,{"no-gutters":"",style:{height:"100%"}},{default:n(()=>[o(L,{cols:"12",lg:"4",class:"editor-panel"},{default:n(()=>[i("div",Je,[e[24]||(e[24]=i("h3",{class:"text-h6 font-weight-bold"},"拓扑文本编辑",-1)),i("div",Ye,[o(d,{variant:"text",size:"small","prepend-icon":"mdi-robot",onClick:e[2]||(e[2]=a=>k.value=!k.value),color:k.value?"primary":"default"},{default:n(()=>e[22]||(e[22]=[u(" AI转换 ")])),_:1,__:[22]},8,["color"]),o(d,{variant:"text",size:"small","prepend-icon":"mdi-help-circle-outline",onClick:e[3]||(e[3]=a=>S.value=!0)},{default:n(()=>e[23]||(e[23]=[u(" 格式说明 ")])),_:1,__:[23]})])]),k.value?(_(),m("div",Ze,[o(re,{modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=a=>p.value=a),onConverted:J,onOpenConfig:e[5]||(e[5]=a=>$.value=!0)},null,8,["modelValue"])])):E("",!0),i("div",et,[o(ie,{modelValue:p.value,"onUpdate:modelValue":e[6]||(e[6]=a=>p.value=a),placeholder:"请输入网络拓扑描述文本...",variant:"outlined","hide-details":"",rows:"25","auto-grow":"",class:"editor-textarea",onInput:G},null,8,["modelValue"])])]),_:1}),o(L,{cols:"12",lg:"8",class:"preview-panel"},{default:n(()=>[e[29]||(e[29]=i("div",{class:"panel-header"},[i("h3",{class:"text-h6 font-weight-bold"},"预览和结果"),i("div",{class:"d-flex align-center"})],-1)),o(de,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=a=>w.value=a),class:"preview-tabs"},{default:n(()=>[o(U,{value:"preview"},{default:n(()=>e[25]||(e[25]=[u("拓扑生成")])),_:1,__:[25]}),o(U,{value:"data"},{default:n(()=>e[26]||(e[26]=[u("解析数据")])),_:1,__:[26]}),o(U,{value:"xml"},{default:n(()=>e[27]||(e[27]=[u("XML代码")])),_:1,__:[27]}),o(U,{value:"history"},{default:n(()=>e[28]||(e[28]=[u("版本历史")])),_:1,__:[28]})]),_:1},8,["modelValue"]),o(_e,{modelValue:w.value,"onUpdate:modelValue":e[8]||(e[8]=a=>w.value=a),class:"preview-content"},{default:n(()=>[o(z,{value:"preview",class:"preview-tab"},{default:n(()=>{var a,I,j;return[o(ue,{"xml-content":(a=s.value)==null?void 0:a.xml_content,"parsed-data":(I=s.value)==null?void 0:I.parsed_data,loading:g.value,"version-id":(j=s.value)==null?void 0:j._id,"processing-steps":x.value,onDownload:F},null,8,["xml-content","parsed-data","loading","version-id","processing-steps"])]}),_:1}),o(z,{value:"data",class:"data-tab"},{default:n(()=>{var a;return[o(ve,{"parsed-data":(a=s.value)==null?void 0:a.parsed_data,loading:g.value},null,8,["parsed-data","loading"])]}),_:1}),o(z,{value:"xml",class:"xml-tab"},{default:n(()=>{var a;return[o(ce,{"xml-content":(a=s.value)==null?void 0:a.xml_content,loading:g.value,onDownload:F},null,8,["xml-content","loading"])]}),_:1}),o(z,{value:"history",class:"history-tab"},{default:n(()=>{var a;return[o(pe,{"project-id":A.value,"current-version-id":(a=s.value)==null?void 0:a._id,onVersionSelected:Y,onVersionSwitched:Z,onNewVersionCreated:ee},null,8,["project-id","current-version-id"])]}),_:1})]),_:1},8,["modelValue"])]),_:1,__:[29]})]),_:1})])])):(_(),m("div",He,[o(r,{size:"80",color:"grey-lighten-1",class:"mb-4"},{default:n(()=>e[14]||(e[14]=[u(" mdi-folder-remove-outline ")])),_:1,__:[14]}),e[16]||(e[16]=i("h3",{class:"text-h5 text-grey-darken-1 mb-2"},"项目不存在",-1)),e[17]||(e[17]=i("p",{class:"text-body-1 text-grey-darken-1 mb-4"}," 请检查项目ID是否正确，或者项目可能已被删除 ",-1)),o(d,{color:"primary",variant:"outlined","prepend-icon":"mdi-arrow-left",onClick:e[0]||(e[0]=a=>t.$router.push("/topology-projects"))},{default:n(()=>e[15]||(e[15]=[u(" 返回项目列表 ")])),_:1,__:[15]})])),o(fe,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=a=>S.value=a)},null,8,["modelValue"]),o(Ve,{modelValue:$.value,"onUpdate:modelValue":e[12]||(e[12]=a=>$.value=a),"max-width":"800px",persistent:""},{default:n(()=>[o(ye,null,{default:n(()=>[o(ge,{class:"d-flex align-center"},{default:n(()=>[o(r,{icon:"mdi-cog",class:"mr-2"}),e[30]||(e[30]=u(" AI配置管理 ")),o(H),o(d,{icon:"mdi-close",variant:"text",onClick:e[10]||(e[10]=a=>$.value=!1)})]),_:1,__:[30]}),o(xe,{class:"pa-6"},{default:n(()=>[o(we,{onClose:e[11]||(e[11]=a=>$.value=!1)})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),_t=Re(tt,[["__scopeId","data-v-809e834c"]]);export{_t as default};
