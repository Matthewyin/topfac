import ut from"./g3p0lTi8.js";import{d as mt,r as g,K as _t,k as vt,o as ft,x as v,z as i,B as n,D as l,C as s,M as k,a as h,g as r,y as u,N as gt,O as pt,P as j,W as xt,A as d,S as yt,J as kt,_ as Ct}from"./CmizF3kP.js";const Vt={class:"version-history"},bt={class:"version-header d-flex align-center justify-space-between mb-4"},wt={class:"text-h6 font-weight-bold"},ht={class:"d-flex align-center"},zt={key:0,class:"text-center pa-8"},$t={key:1,class:"text-center pa-8"},St={key:2,class:"versions-list"},Bt={class:"flex-grow-1"},jt={class:"d-flex align-center"},It={class:"text-h6 font-weight-bold mr-2"},At={class:"text-body-2 text-grey-darken-1 mb-0 mt-1"},Mt={class:"version-stats mb-3"},Nt={class:"stat-item"},Tt={class:"text-body-2 font-weight-medium"},Ft={class:"stat-item"},Et={class:"text-body-2 font-weight-medium"},Kt={class:"stat-item"},Lt={class:"text-body-2 font-weight-medium"},Ut={key:0,class:"change-summary mb-3"},Zt={class:"text-body-2"},Pt={key:1,class:"parsed-preview"},Wt={class:"d-flex align-center flex-wrap"},Gt={key:0,class:"d-flex justify-center mt-6"},Ht=mt({__name:"VersionHistory",props:{projectId:{},currentVersionId:{}},emits:["versionSelected","versionSwitched","newVersionCreated"],setup(E,{emit:K}){const I=E,z=K,C=g(!1),$=g(!1),V=g([]),S=g(!1),p=g(!1),L=g([]),x=g(null),_=_t({page:1,limit:16,total:0,pages:0}),U=vt(()=>[...V.value].sort((e,t)=>(t.version||0)-(e.version||0))),y=async()=>{C.value=!0;try{const{$topologyApi:e}=h(),t=await e.projects.getVersions(I.projectId,{page:_.page,limit:_.limit});V.value=t.data.versions,_.total=t.data.pagination.total,_.pages=t.data.pagination.pages}catch(e){console.error("加载版本历史失败:",e)}finally{C.value=!1}},Z=e=>{z("versionSelected",e)},P=e=>{z("versionSwitched",e)},A=()=>{z("newVersionCreated")},W=async e=>{try{const{$topologyApi:t}=h();await t.projects.createVersion(I.projectId,{text_content:e.text_content,change_summary:`复制自版本 v${e.version}`}),await y()}catch(t){console.error("复制版本失败:",t)}},G=async e=>{try{const{$topologyApi:t}=h();await t.download(e._id)}catch(t){console.error("下载版本失败:",t)}},H=e=>{x.value=e,p.value=!0},J=async()=>{if(x.value){$.value=!0;try{const{$topologyApi:e}=h();await e.versions.delete(x.value._id),await y(),p.value=!1,x.value=null}catch(e){console.error("删除版本失败:",e)}finally{$.value=!1}}},O=e=>({draft:"grey",parsed:"info",generated:"success",published:"primary"})[e]||"grey",q=e=>({draft:"草稿",parsed:"已解析",generated:"已生成",published:"已发布"})[e]||"未知",Q=e=>{if(!e)return"";let t=e;return!e.endsWith("Z")&&!e.includes("+")&&(t=e+"Z"),new Date(t).toLocaleString("sv-SE",{timeZone:"Asia/Shanghai"})},R=e=>e<1e3?`${e} 字符`:`${(e/1e3).toFixed(1)}K 字符`,X=e=>{if(e===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],c=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,c)).toFixed(1))+" "+a[c]},Y=e=>{var t;return((t=e==null?void 0:e.statistics)==null?void 0:t.environment_count)!==void 0?e.statistics.environment_count:((e==null?void 0:e.environments)||[]).length},D=e=>{var a;if(((a=e==null?void 0:e.statistics)==null?void 0:a.datacenter_count)!==void 0)return e.statistics.datacenter_count;let t=0;if(e!=null&&e.environments)for(const c of e.environments)t+=(c.datacenters||[]).length;return t},tt=e=>{var a;if(((a=e==null?void 0:e.statistics)==null?void 0:a.area_count)!==void 0)return e.statistics.area_count;let t=0;if(e!=null&&e.environments){for(const c of e.environments)if(c.datacenters)for(const B of c.datacenters)t+=(B.areas||[]).length}return t},et=e=>{var t;return((t=e==null?void 0:e.statistics)==null?void 0:t.component_count)!==void 0?e.statistics.component_count:((e==null?void 0:e.components)||[]).length},ot=e=>{var t;return((t=e==null?void 0:e.statistics)==null?void 0:t.connection_count)!==void 0?e.statistics.connection_count:((e==null?void 0:e.connections)||[]).length};return ft(()=>{y()}),(e,t)=>{const a=r("v-icon"),c=r("v-btn"),B=r("v-progress-circular"),f=r("v-chip"),b=r("v-list-item"),nt=r("v-divider"),st=r("v-list"),it=r("v-menu"),M=r("v-card-title"),w=r("v-col"),N=r("v-row"),T=r("v-card-text"),F=r("v-card"),lt=r("v-pagination"),rt=ut,ct=r("v-spacer"),dt=r("v-card-actions"),at=r("v-dialog");return u(),v("div",Vt,[i("div",bt,[i("h3",wt,[n(a,{class:"mr-2",color:"info"},{default:s(()=>t[6]||(t[6]=[l("mdi-history")])),_:1,__:[6]}),t[7]||(t[7]=l(" 版本历史 "))]),i("div",ht,[n(c,{variant:"outlined",size:"small","prepend-icon":"mdi-refresh",onClick:y,loading:C.value,class:"mr-2"},{default:s(()=>t[8]||(t[8]=[l(" 刷新 ")])),_:1,__:[8]},8,["loading"]),n(c,{color:"primary",size:"small","prepend-icon":"mdi-plus",onClick:A},{default:s(()=>t[9]||(t[9]=[l(" 新建版本 ")])),_:1,__:[9]})])]),C.value?(u(),v("div",zt,[n(B,{indeterminate:"",color:"primary",size:"48"}),t[10]||(t[10]=i("p",{class:"text-body-2 text-grey-darken-1 mt-4"},"加载版本历史中...",-1))])):V.value.length===0?(u(),v("div",$t,[n(a,{size:"64",color:"grey-lighten-1",class:"mb-4"},{default:s(()=>t[11]||(t[11]=[l(" mdi-history ")])),_:1,__:[11]}),t[13]||(t[13]=i("h4",{class:"text-h6 text-grey-darken-1 mb-2"},"暂无版本历史",-1)),t[14]||(t[14]=i("p",{class:"text-body-2 text-grey-darken-1 mb-4"}," 开始创建您的第一个版本 ",-1)),n(c,{color:"primary",variant:"outlined","prepend-icon":"mdi-plus",onClick:A},{default:s(()=>t[12]||(t[12]=[l(" 创建版本 ")])),_:1,__:[12]})])):(u(),v("div",St,[n(N,{class:"version-grid"},{default:s(()=>[(u(!0),v(gt,null,pt(U.value,(o,Jt)=>(u(),j(w,{key:o._id,cols:"12",sm:"6",md:"3",class:"version-col"},{default:s(()=>[n(F,{class:xt(["version-card",{"current-version":o._id===e.currentVersionId}]),variant:"outlined",onClick:m=>Z(o)},{default:s(()=>[n(M,{class:"d-flex align-center pa-4"},{default:s(()=>[i("div",Bt,[i("div",jt,[i("h4",It," v"+d(o.version),1),n(f,{color:O(o.status),variant:"flat",size:"small",class:"text-white mr-2"},{default:s(()=>[l(d(q(o.status)),1)]),_:2},1032,["color"]),o._id===e.currentVersionId?(u(),j(f,{key:0,color:"success",variant:"outlined",size:"small"},{default:s(()=>t[15]||(t[15]=[l(" 当前版本 ")])),_:1,__:[15]})):k("",!0)]),i("p",At,d(Q(o.created_at)),1)]),n(it,{location:"bottom end"},{activator:s(({props:m})=>[n(c,yt({icon:"mdi-dots-vertical",variant:"text",size:"small"},{ref_for:!0},m,{onClick:t[0]||(t[0]=kt(()=>{},["stop"]))}),null,16)]),default:s(()=>[n(st,{density:"compact"},{default:s(()=>[o._id!==e.currentVersionId?(u(),j(b,{key:0,"prepend-icon":"mdi-check",title:"切换到此版本",onClick:m=>P(o)},null,8,["onClick"])):k("",!0),n(b,{"prepend-icon":"mdi-content-copy",title:"复制版本",onClick:m=>W(o)},null,8,["onClick"]),n(b,{"prepend-icon":"mdi-download",title:"下载",onClick:m=>G(o),disabled:!o.xml_content},null,8,["onClick","disabled"]),n(nt),n(b,{"prepend-icon":"mdi-delete",title:"删除版本",class:"text-error",onClick:m=>H(o),disabled:o._id===e.currentVersionId||V.value.length===1},null,8,["onClick","disabled"])]),_:2},1024)]),_:2},1024)]),_:2},1024),n(T,{class:"pa-4 pt-0"},{default:s(()=>[i("div",Mt,[n(N,{dense:""},{default:s(()=>[n(w,{cols:"4"},{default:s(()=>{var m;return[i("div",Nt,[t[16]||(t[16]=i("div",{class:"text-caption text-grey-darken-1"},"文本长度",-1)),i("div",Tt,d(R(((m=o.text_content)==null?void 0:m.length)||0)),1)])]}),_:2},1024),n(w,{cols:"4"},{default:s(()=>[i("div",Ft,[t[17]||(t[17]=i("div",{class:"text-caption text-grey-darken-1"},"文件大小",-1)),i("div",Et,d(X(o.file_size||0)),1)])]),_:2},1024),n(w,{cols:"4"},{default:s(()=>[i("div",Kt,[t[18]||(t[18]=i("div",{class:"text-caption text-grey-darken-1"},"处理状态",-1)),i("div",Lt,d(o.xml_content?"已生成":"未生成"),1)])]),_:2},1024)]),_:2},1024)]),o.change_summary?(u(),v("div",Ut,[t[19]||(t[19]=i("div",{class:"text-caption text-grey-darken-1 mb-1"},"变更摘要：",-1)),i("p",Zt,d(o.change_summary),1)])):k("",!0),o.parsed_data?(u(),v("div",Pt,[t[20]||(t[20]=i("div",{class:"text-caption text-grey-darken-1 mb-2"},"解析结果：",-1)),i("div",Wt,[n(f,{size:"x-small",variant:"outlined",color:"purple",class:"mr-1 mb-1"},{default:s(()=>[l(d(Y(o.parsed_data))+" 环境 ",1)]),_:2},1024),n(f,{size:"x-small",variant:"outlined",color:"info",class:"mr-1 mb-1"},{default:s(()=>[l(d(D(o.parsed_data))+" 数据中心 ",1)]),_:2},1024),n(f,{size:"x-small",variant:"outlined",color:"warning",class:"mr-1 mb-1"},{default:s(()=>[l(d(tt(o.parsed_data))+" 网络区域 ",1)]),_:2},1024),n(f,{size:"x-small",variant:"outlined",color:"success",class:"mr-1 mb-1"},{default:s(()=>[l(d(et(o.parsed_data))+" 设备 ",1)]),_:2},1024),n(f,{size:"x-small",variant:"outlined",color:"orange",class:"mr-1 mb-1"},{default:s(()=>[l(d(ot(o.parsed_data))+" 连接 ",1)]),_:2},1024)])])):k("",!0)]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024))),128))]),_:1}),_.pages>1?(u(),v("div",Gt,[n(lt,{modelValue:_.page,"onUpdate:modelValue":[t[1]||(t[1]=o=>_.page=o),y],length:_.pages,"total-visible":5},null,8,["modelValue","length"])])):k("",!0)])),n(rt,{modelValue:S.value,"onUpdate:modelValue":t[2]||(t[2]=o=>S.value=o),versions:L.value,onClose:t[3]||(t[3]=o=>S.value=!1)},null,8,["modelValue","versions"]),n(at,{modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=o=>p.value=o),"max-width":"400"},{default:s(()=>[n(F,null,{default:s(()=>[n(M,{class:"text-h6"},{default:s(()=>t[21]||(t[21]=[l(" 确认删除版本 ")])),_:1,__:[21]}),n(T,null,{default:s(()=>{var o;return[l(" 确定要删除版本 v"+d((o=x.value)==null?void 0:o.version)+" 吗？ ",1),t[22]||(t[22]=i("br",null,null,-1)),t[23]||(t[23]=i("span",{class:"text-error"},"此操作不可撤销。",-1))]}),_:1,__:[22,23]}),n(dt,null,{default:s(()=>[n(ct),n(c,{variant:"text",onClick:t[4]||(t[4]=o=>p.value=!1)},{default:s(()=>t[24]||(t[24]=[l(" 取消 ")])),_:1,__:[24]}),n(c,{color:"error",variant:"text",loading:$.value,onClick:J},{default:s(()=>t[25]||(t[25]=[l(" 删除 ")])),_:1,__:[25]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Qt=Ct(Ht,[["__scopeId","data-v-84cd355e"]]);export{Qt as default};
