# OpenResty日志轮转配置
# 保留180天的访问日志
# 
# 安装方法：
# sudo cp config/logrotate-openresty.conf /etc/logrotate.d/openresty
# sudo chmod 644 /etc/logrotate.d/openresty
# 
# 测试配置：
# sudo logrotate -d /etc/logrotate.d/openresty
# 
# 手动执行：
# sudo logrotate -f /etc/logrotate.d/openresty

/var/log/openresty/*.log {
    # 每天轮转一次
    daily
    
    # 保留180天（6个月）
    rotate 180
    
    # 如果日志文件不存在，不报错
    missingok
    
    # 如果日志文件为空，不轮转
    notifempty
    
    # 压缩旧日志
    compress
    
    # 延迟压缩（轮转后的第二天才压缩）
    # 这样可以避免在日志还在写入时压缩
    delaycompress
    
    # 日志文件的权限
    create 0640 www-data adm
    
    # 多个日志文件共享脚本
    sharedscripts
    
    # 轮转后执行的脚本
    # 向OpenResty发送USR1信号，重新打开日志文件
    postrotate
        if [ -f /var/run/openresty.pid ]; then
            kill -USR1 `cat /var/run/openresty.pid`
        fi
    endscript
    
    # 日志文件名格式
    # 例如：access.log-20251003.gz
    dateext
    dateformat -%Y%m%d
    
    # 如果日志文件大于100M，立即轮转（即使还没到每天的时间）
    maxsize 100M
}

